<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VF.DEV | Hub de Concursos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Biblioteca para gerar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-XXXXXXXXXXXXXXXX" crossorigin="anonymous"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .penal-gradient { background: linear-gradient(135deg, #1e3a8a 0%, #1e1b4b 100%); }
        .ufmg-gradient { background: linear-gradient(135deg, #991b1b 0%, #450a0a 100%); }
        
        /* Estilos para o feedback visual das questões */
        .option-card { transition: all 0.2s; }
        .option-card input:checked + div { border-color: #1e40af; background-color: #dbeafe; }
        
        /* Classes aplicadas via JS após responder */
        .option-card.correct div { background-color: #dcfce7 !important; border-color: #22c55e !important; color: #14532d; }
        .option-card.wrong div { background-color: #fee2e2 !important; border-color: #ef4444 !important; color: #7f1d1d; }
        
        .animate-fadeIn { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .ad-container {
            margin: 2rem auto; 
            text-align: center; 
            background: #f1f5f9; 
            border-radius: 1rem;
            padding: 1rem; 
            min-height: 100px; 
            width: 100%; 
            min-width: 250px;
            position: relative; 
            border: 1px dashed #cbd5e1;
            display: block;
            overflow: hidden;
        }

        /* Toast Notifications */
        #toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .toast {
            min-width: 300px;
            padding: 1rem;
            border-radius: 0.5rem;
            background: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-left: 4px solid;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .toast.show { transform: translateX(0); }
        .toast-success { border-left-color: #22c55e; }
        .toast-error { border-left-color: #ef4444; }
        .toast-info { border-left-color: #3b82f6; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

<!-- TOAST CONTAINER -->
<div id="toast-container"></div>

<!-- HEADER -->
<header class="penal-gradient text-white sticky top-0 z-50 shadow-xl">
    <div class="max-w-7xl mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
        <div class="flex items-center gap-3">
            <div class="bg-white/20 p-2 rounded-lg"><i class="fas fa-shield-halved text-2xl"></i></div>
            <div>
                <h1 class="text-xl font-bold tracking-tight text-white uppercase leading-none">VF<span class="text-red-500">.DEV</span></h1>
                <div id="user-badge" class="text-[10px] font-medium text-blue-200 flex items-center gap-1 mt-1">
                    <span class="w-2 h-2 bg-green-400 rounded-full"></span>
                    <span id="display-name">Visitante</span>
                </div>
            </div>
        </div>
        <nav class="flex gap-2">
            <button onclick="navigate('hub')" class="px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-sm font-semibold flex items-center gap-2 transition-all">
                <i class="fas fa-th-large"></i> Hub
            </button>
            <button onclick="navigate('ranking')" class="px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-sm font-semibold flex items-center gap-2 transition-all">
                <i class="fas fa-trophy"></i> Ranking
            </button>
            <button onclick="handleLogout()" class="px-4 py-2 rounded-lg bg-red-500/10 hover:bg-red-500/20 text-red-400 text-sm font-semibold transition-all">
                <i class="fas fa-sign-out-alt"></i> Sair
            </button>
        </nav>
    </div>
</header>

<!-- AUTH MODAL (SIMPLIFICADO - APENAS NICK) -->
<div id="login-modal" class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/95 p-4 transition-opacity duration-500">
    <div class="bg-white rounded-2xl p-8 max-w-md w-full shadow-2xl text-center relative">
        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-6">
            <i class="fas fa-user-astronaut text-2xl text-blue-700"></i>
        </div>
        <h2 class="text-2xl font-bold text-slate-800 mb-2">Identificação</h2>
        <p class="text-slate-500 mb-6 text-sm">Digite seu Nickname (Apelido) para acessar os simulados e ter seu nome no ranking.</p>
        
        <div class="space-y-4">
            <input type="text" id="nickname-input" placeholder="Seu apelido..." class="w-full px-4 py-4 rounded-xl border-2 border-slate-200 focus:border-blue-500 focus:outline-none text-lg text-center font-bold text-slate-700" maxlength="20">
            
            <button onclick="handleNickLogin()" class="w-full bg-blue-700 hover:bg-blue-800 text-white font-bold py-4 rounded-xl transition-all shadow-lg hover:shadow-xl hover:scale-[1.02]">
                ENTRAR NO HUB
            </button>
        </div>
        
        <p class="mt-6 text-xs text-slate-400">Ao entrar, seus resultados serão salvos no Hall da Fama.</p>
    </div>
</div>

<main class="flex-grow max-w-5xl mx-auto w-full p-4 md:p-6">
    
    <!-- HUB SECTION -->
    <section id="section-hub" class="space-y-6 animate-fadeIn">
        <div class="text-center mb-8">
            <h2 class="text-3xl font-extrabold text-slate-800">Selecione seu Foco</h2>
            <p class="text-slate-500">Escolha a instituição para visualizar os editais disponíveis.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- PPMG -->
            <div onclick="selectInstitution('ppmg')" class="group cursor-pointer bg-white rounded-3xl p-8 shadow-sm border border-slate-200 transition-all hover:shadow-xl hover:-translate-y-2">
                <div class="w-16 h-16 penal-gradient rounded-2xl flex items-center justify-center text-white mb-6 group-hover:rotate-6 transition-transform">
                    <i class="fas fa-gavel text-2xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-slate-800">PPMG</h3>
                <p class="text-slate-500 text-sm mt-2">Polícia Penal de Minas Gerais. Conteúdo jurídico técnico e segurança pública.</p>
                <div class="mt-6 flex items-center text-blue-600 font-bold text-sm">
                    Ver Editais <i class="fas fa-arrow-right ml-2 group-hover:translate-x-2 transition-transform"></i>
                </div>
            </div>

            <!-- UFMG -->
            <div onclick="selectInstitution('ufmg')" class="group cursor-pointer bg-white rounded-3xl p-8 shadow-sm border border-slate-200 transition-all hover:shadow-xl hover:-translate-y-2">
                <div class="w-16 h-16 ufmg-gradient rounded-2xl flex items-center justify-center text-white mb-6 group-hover:rotate-6 transition-transform">
                    <i class="fas fa-university text-2xl"></i>
                </div>
                <div class="flex justify-between items-start">
                    <h3 class="text-2xl font-bold text-slate-800">UFMG</h3>
                    <span class="bg-red-100 text-red-700 text-[10px] font-bold px-2 py-1 rounded-full uppercase">PRORH</span>
                </div>
                <p class="text-slate-500 text-sm mt-2">Editais da Universidade Federal de Minas Gerais. Técnico-Administrativos e Docentes.</p>
                <div class="mt-6 flex items-center text-red-600 font-bold text-sm">
                    Ver Editais <i class="fas fa-arrow-right ml-2 group-hover:translate-x-2 transition-transform"></i>
                </div>
            </div>
        </div>
    </section>

    <!-- EXAMS SELECTION -->
    <section id="section-exams" class="hidden animate-fadeIn space-y-6">
        <div class="flex items-center gap-4 mb-6">
            <button onclick="navigate('hub')" class="w-10 h-10 rounded-full bg-white shadow-sm border flex items-center justify-center text-slate-400 hover:text-slate-800 transition-colors"><i class="fas fa-arrow-left"></i></button>
            <h2 class="text-2xl font-bold text-slate-800" id="current-institution-name">Concursos</h2>
        </div>
        
        <div class="space-y-8">
            <div>
                <h3 class="text-lg font-bold text-green-600 mb-4 flex items-center gap-2"><i class="fas fa-unlock"></i> Concursos em Aberto</h3>
                <div id="open-exams-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>
            <div>
                <h3 class="text-lg font-bold text-amber-600 mb-4 flex items-center gap-2"><i class="fas fa-hourglass-half"></i> Concursos Previstos</h3>
                <div id="planned-exams-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>
        </div>
    </section>

    <!-- SUBJECTS SECTION -->
    <section id="section-subjects" class="hidden animate-fadeIn space-y-6">
        <div class="flex items-center gap-4 mb-6">
            <button onclick="navigate('exams')" class="w-10 h-10 rounded-full bg-white shadow-sm border flex items-center justify-center text-slate-400 hover:text-slate-800 transition-colors"><i class="fas fa-arrow-left"></i></button>
            <div class="flex flex-col">
                <h2 class="text-xl font-bold text-slate-800" id="current-exam-name">Disciplinas do Edital</h2>
                <div id="current-exam-status"></div>
            </div>
        </div>
        <div id="subjects-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
    </section>

    <!-- SIMULADO SCREEN -->
    <section id="section-active-simulado" class="hidden">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 bg-white p-4 rounded-2xl shadow-sm border border-slate-200 sticky top-[80px] z-40">
            <div class="flex items-center gap-3">
                <button onclick="navigate('subjects')" class="w-10 h-10 rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200 transition-colors"><i class="fas fa-arrow-left"></i></button>
                <h2 class="text-xl font-bold text-slate-800" id="simulado-title">Simulado</h2>
            </div>
            <div class="flex items-center gap-4 w-full md:w-auto">
                <div class="flex-grow md:w-48 bg-slate-200 h-2 rounded-full overflow-hidden">
                    <div id="progress-bar" class="bg-blue-600 h-full w-0 transition-all duration-500"></div>
                </div>
                <div class="font-bold text-blue-700 whitespace-nowrap" id="simulado-counter">0/20</div>
            </div>
        </div>
        <div id="questions-area" class="space-y-6"></div>
        <div id="finish-simulado-area" class="hidden py-10 text-center space-y-4">
            <button onclick="saveSimuladoResult()" class="bg-blue-700 hover:bg-blue-800 text-white font-bold py-4 px-10 rounded-2xl shadow-xl transition-all hover:scale-105 w-full md:w-auto">CONSOLIDAR RESULTADO</button>
            
            <button onclick="downloadResultPDF()" class="bg-white border-2 border-slate-200 text-slate-600 hover:bg-slate-50 font-bold py-3 px-8 rounded-xl shadow-sm transition-all flex items-center justify-center gap-2 w-full md:w-auto mx-auto">
                <i class="fas fa-file-pdf text-red-500"></i> BAIXAR GABARITO (PDF)
            </button>
        </div>
    </section>

    <!-- RANKING SECTION -->
    <section id="section-ranking" class="hidden animate-fadeIn space-y-6">
        <div class="text-center mb-10">
            <div class="inline-block p-3 bg-amber-100 text-amber-600 rounded-2xl mb-4"><i class="fas fa-trophy text-2xl"></i></div>
            <h2 class="text-3xl font-bold text-slate-800">Hall da Fama dos Estudantes</h2>
            <p class="text-slate-500">Métricas consolidadas de aproveitamento.</p>
        </div>

        <!-- Filtros do Ranking -->
        <div class="flex justify-center gap-2 mb-6">
            <button onclick="setRankingFilter('all')" id="btn-rank-all" class="px-6 py-2 rounded-full text-sm font-bold bg-blue-600 text-white shadow-md hover:bg-blue-700 transition-all">Geral</button>
            <button onclick="setRankingFilter('ppmg')" id="btn-rank-ppmg" class="px-6 py-2 rounded-full text-sm font-bold bg-white text-slate-500 border border-slate-200 hover:border-blue-300 hover:text-blue-600 transition-all">PPMG</button>
            <button onclick="setRankingFilter('ufmg')" id="btn-rank-ufmg" class="px-6 py-2 rounded-full text-sm font-bold bg-white text-slate-500 border border-slate-200 hover:border-blue-300 hover:text-blue-600 transition-all">UFMG</button>
        </div>

        <div class="max-w-2xl mx-auto bg-white rounded-3xl p-6 shadow-sm border border-slate-200">
            <div id="ranking-list" class="space-y-3 text-center text-slate-400 py-10">Conectando ao banco...</div>
        </div>
    </section>

</main>

<!-- ADSENSE -->
<div class="max-w-5xl mx-auto w-full px-4 md:px-6">
    <div class="ad-container" id="ad-hub-footer">
        <span class="ad-label">Anúncio</span>
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-XXXXXXXXXXXXXXXX"
             data-ad-slot="YYYYYYYYYY"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
    </div>
</div>

<footer class="bg-slate-100 py-8 mt-12 border-t border-slate-200 text-center text-slate-400 text-[10px] font-medium">
    VF.DEV © 2026 - Hub Independente de Engenharia Penal e Concursos Federais.
</footer>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, onSnapshot, query, orderBy, limit, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
    
    // --- FIREBASE CONFIG ---
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
        apiKey: "AIzaSyDzXxf_dalGOjJ_ADh3nSlkYuHYvMzvO0w",
        authDomain: "ambiente-de-estudo-43550.firebaseapp.com",
        projectId: "ambiente-de-estudo-43550",
        storageBucket: "ambiente-de-estudo-43550.firebasestorage.app",
        messagingSenderId: "220895066892",
        appId: "1:220895066892:web:33370a72e40df87f836729",
        measurementId: "G-NPGKL5T9R0"
    };
    
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'vf-dev-hub-v1';

    // --- GLOBAL STATE ---
    let user = null;
    let userName = "";
    let currentInstitution = 'ppmg';
    let currentExamId = '';
    let activeQuestions = [];
    let currentScore = 0;
    let answeredCount = 0;
    let userAnswers = []; // Armazena as respostas para o PDF
    let allRankingsData = [];
    let currentRankingFilter = 'all';

    // --- TOAST UTILS ---
    window.showToast = (message, type = 'info') => {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        
        let iconClass = 'fa-info-circle';
        if(type === 'success') iconClass = 'fa-check-circle text-green-500';
        if(type === 'error') iconClass = 'fa-exclamation-circle text-red-500';
        if(type === 'info') iconClass = 'fa-info-circle text-blue-500';

        toast.innerHTML = `
            <div class="flex items-center gap-3">
                <i class="fas ${iconClass} text-lg"></i>
                <span class="text-slate-700 text-sm font-medium">${message}</span>
            </div>
        `;
        
        container.appendChild(toast);
        requestAnimationFrame(() => toast.classList.add('show'));
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    };

    // --- AUTH LOGIC (NICKNAME ONLY) ---
    window.handleNickLogin = async () => {
        const nickInput = document.getElementById('nickname-input');
        const nick = nickInput.value.trim();
        
        if (!nick) return showToast("Por favor, digite um apelido para entrar.", 'error');
        if (nick.length < 3) return showToast("O apelido deve ter pelo menos 3 caracteres.", 'error');

        try {
            await signInAnonymously(auth);
            localStorage.setItem('user_nick', nick);
            userName = nick;
            document.getElementById('display-name').innerText = userName;
            document.getElementById('login-modal').classList.add('hidden');
            showToast(`Bem-vindo, ${nick}!`, 'success');
        } catch(e) { 
            console.error(e);
            showToast("Erro ao conectar. Tente novamente.", 'error'); 
        }
    };

    window.handleLogout = () => signOut(auth).then(() => {
        localStorage.removeItem('user_nick');
        window.location.reload();
    });

    // --- DATA STRUCTURE (EDITAL-BASED) ---
    const INSTITUTIONS_DATA = {
        'ppmg': {
            name: 'PPMG (Polícia Penal MG)',
            exams: [
                {
                    id: 'ppmg_2026',
                    name: 'Polícia Penal - Edital 2025/2026',
                    status: 'open',
                    pdfUrl: 'https://www.institutoaocp.org.br/concursos/672', 
                    subjects: [
                        { id: 'lep', name: 'Lei de Execução Penal', icon: 'fa-gavel' },
                        { id: 'const', name: 'Direito Constitucional', icon: 'fa-balance-scale' },
                        { id: 'leg_esp', name: 'Legislação Especial', icon: 'fa-book-open' } // ADICIONADO
                    ]
                }
            ]
        },
        'ufmg': {
            name: 'UFMG (Concursos PRORH / COPEVE)',
            exams: [
                {
                    id: 'ufmg_tae_2025',
                    name: 'Técnico-Administrativo (TAE) - Edital 01/2025',
                    status: 'open',
                    pdfUrl: 'https://arq.pciconcursos.com.br/ufmg-abre-edital-de-concurso-publico-para-cargo-de-tecnico-administrativo-em-educacao/1692458/7ab8cc9fd2/edital_de_abertura_n_3428_2025_1692458.pdf',
                    subjects: [
                        { id: 'ufmg_pt', name: 'Língua Portuguesa', icon: 'fa-language' },
                        { id: 'ufmg_leg', name: 'Legislação (Lei 8.112)', icon: 'fa-scroll' },
                        { id: 'ufmg_adm', name: 'Noções de Adm. Pública', icon: 'fa-sitemap' }
                    ]
                },
                {
                    id: 'ufmg_docente_2026',
                    name: 'Docente - Diversas Áreas (Magistério)',
                    status: 'planned',
                    pdfUrl: 'https://site.copeve.ufmg.br/', 
                    subjects: [
                        { id: 'ufmg_didat', name: 'Didática e Legislação', icon: 'fa-chalkboard-teacher' }
                    ]
                }
            ]
        }
    };

    // --- BANCO DE QUESTÕES (60 QUESTÕES TOTAIS) ---
    const DB_QUESTIONS = [
        // --- 20 QUESTÕES: LEGISLAÇÃO ESPECIAL (Baseadas no PDF + Conhecimentos PPMG) ---
        { examId: 'ppmg_2026', type: 'leg_esp', q: "Segundo o entendimento do STF no julgamento do RE 635659 (Tema 506), o porte de cannabis sativa para uso pessoal:", options: ["A) É crime inafiançável.", "B) É infração penal sujeita à prisão simples.", "C) Foi descriminalizado, mantendo-se como ilícito administrativo.", "D) Deixou de ser qualquer tipo de ilícito."], correct: 2, exp: "O STF decidiu que o porte para uso pessoal não é crime, mas subsiste como ilícito administrativo, sujeito a sanções não penais." },
        { examId: 'ppmg_2026', type: 'leg_esp', q: "Sobre o 'tráfico privilegiado' (art. 33, §4° da Lei 11.343), é correto afirmar:", options: ["A) É crime hediondo.", "B) Não permite substituição da pena privativa por restritiva.", "C) Aplica-se a réus primários, bons antecedentes, não dedicados a crimes.", "D) Exige que o réu seja reincidente."], correct: 2, exp: "Requisitos: primariedade, bons antecedentes, não dedicação a atividades criminosas nem integrar organização criminosa." },
        { examId: 'ppmg_2026', type: 'leg_esp', q: "Segundo a Lei 8.072/90, é considerado crime HEDIONDO:", options: ["A) Furto simples.", "B) Roubo circunstanciado pelo emprego de arma branca.", "C) Posse ou porte ilegal de arma de fogo de uso proibido.", "D) Homicídio culposo."], correct: 2, exp: "O Pacote Anticrime incluiu a posse/porte de arma de uso proibido no rol dos hediondos." },
        { examId: 'ppmg_2026', type: 'leg_esp', q: "NÃO é crime hediondo:", options: ["A) Lesão corporal gravíssima contra policial.", "B) Extorsão mediante sequestro.", "C) Sequestro e cárcere privado (art. 148, caput).", "D) Estupro de vulnerável."], correct: 2, exp: "O sequestro simples (art. 148) não está no rol taxativo da Lei 8.072/90." },
        { examId: 'ppmg_2026', type: 'leg_esp', q: "Lei de Abuso de Autoridade (13.869/19): A divergência na interpretação de lei ou avaliação de fatos:", options: ["A) Configura crime de abuso.", "B) É agravante de pena.", "C) Não configura abuso de autoridade.", "D) Depende da vontade do MP."], correct: 2, exp: "Art. 1º, § 2º: A divergência na interpretação de lei ou na avaliação de fatos e provas não configura abuso de autoridade (crime de hermenêutica)." },
        { examId: 'ppmg_2026', type: 'leg_esp', q: "Constitui crime de abuso de autoridade:", options: ["A) Decretar prisão preventiva quando presentes os requisitos.", "B) Deixar de comunicar imediatamente a prisão de qualquer pessoa à família.", "C) Algemar preso perigoso.", "D) Interrogar durante o dia."], correct: 1, exp: "É crime deixar de comunicar a prisão imediatamente à família ou pessoa indicada pelo preso." },
        { examId: 'ppmg_2026', type: 'leg_esp', q: "Interrogatório policial durante o repouso noturno (salvo flagrante ou consentimento) é:", options: ["A) Permitido sempre.", "B) Crime de Abuso de Autoridade.", "C) Infração disciplinar apenas.", "D) Permitido se o delegado quiser."], correct: 1, exp: "Art. 18 da Lei 13.869/19 criminaliza o interrogatório noturno sem as exceções legais." },
        { examId: 'ppmg_2026', type: 'leg_esp', q: "Idade mínima para aquisição de arma de fogo de uso permitido (Lei 10.826/03):", options: ["A) 18 anos.", "B) 21 anos.", "C) 25 anos.", "D) 30 anos."], correct: 2, exp: "Art. 28: A idade mínima é de 25 anos." },
        { examId: 'ppmg_2026', type: 'leg_esp', q: "Portar arma de fogo de uso permitido com numeração raspada configura:", options: ["A) Porte de arma de uso permitido.", "B) Posse irregular.", "C) Crime equiparado a porte de arma de uso restrito.", "D) Contravenção."], correct: 2, exp: "A supressão da numeração (art. 16) equipara a conduta ao porte de arma de uso restrito, com pena mais grave." },
        { examId: 'ppmg_2026', type: 'leg_esp', q: "Frentista que porta arma registrada no local de trabalho (posto) sem ser o dono e sem porte:", options: ["A) Não comete crime.", "B) Comete Porte Ilegal de Arma de Fogo.", "C) Comete Posse Irregular.", "D) Age em estrito cumprimento do dever."], correct: 1, exp: "O registro permite posse (interior da residência ou trabalho se for o titular). Funcionário armado comete porte ilegal." },
        { examId: 'ppmg_2026', type: 'leg_esp', q: "Lei Maria da Penha: A coabitação para configurar violência doméstica é:", options: ["A) Obrigatória.", "B) Desnecessária (prescindível).", "C) Obrigatória se não forem casados.", "D) Irrelevante se houver filhos."], correct: 1, exp: "Súmula 600 STJ e Art. 5º: A coabitação é dispensável (prescindível)." },
        { examId: 'ppmg_2026', type: 'leg_esp', q: "Violência Psicológica (Maria da Penha) inclui:", options: ["A) Bater na vítima.", "B) Reter dinheiro.", "C) Diminuição da autoestima, humilhação, isolamento.", "D) Calúnia."], correct: 2, exp: "Art. 7º, II: Dano emocional e diminuição da autoestima configuram violência psicológica." },
        { examId: 'ppmg_2026', type: 'leg_esp', q: "Medida protetiva que retira a arma do agressor:", options: ["A) Suspensão da posse ou restrição do porte de armas.", "B) Apreensão de CNH.", "C) Bloqueio de contas.", "D) Prisão preventiva imediata sem requisitos."], correct: 0, exp: "Art. 22, I: O juiz pode determinar a suspensão da posse ou restrição do porte de armas." },
        { examId: 'ppmg_2026', type: 'leg_esp', q: "Lei de Tortura: A omissão perante a tortura (quando se tem o dever de evitar) é punida com:", options: ["A) Reclusão.", "B) Detenção.", "C) Multa.", "D) Prisão simples."], correct: 1, exp: "A tortura-omissão é o único tipo da lei punido com Detenção (1 a 4 anos)." },
        { examId: 'ppmg_2026', type: 'leg_esp', q: "O crime de tortura é:", options: ["A) Afiançável.", "B) Inafiançável e insuscetível de graça ou anistia.", "C) Prescritível em 2 anos.", "D) De menor potencial ofensivo."], correct: 1, exp: "Art. 5º, XLIII CF e Lei 9.455: Inafiançável e insuscetível de graça/anistia." },
        { examId: 'ppmg_2026', type: 'leg_esp', q: "LEP: A remição pelo trabalho é de:", options: ["A) 1 dia de pena por 2 trabalhados.", "B) 1 dia de pena por 3 trabalhados.", "C) 2 dias de pena por 3 trabalhados.", "D) 1 dia de pena por 1 trabalhado."], correct: 1, exp: "Art. 126: A contagem é 1 dia de pena a cada 3 dias de trabalho." },
        { examId: 'ppmg_2026', type: 'leg_esp', q: "O RDD (Regime Disciplinar Diferenciado) pode durar até:", options: ["A) 360 dias.", "B) 1 ano.", "C) 2 anos, renovável.", "D) 6 meses."], correct: 2, exp: "Pacote Anticrime: prazo máximo de 2 anos, repetível em caso de nova falta grave." },
        { examId: 'ppmg_2026', type: 'leg_esp', q: "Princípio da Execução Penal em MG (Lei 11.404):", options: ["A) Vingança social.", "B) Reeducação, reintegração e prevenção da reincidência.", "C) Apenas custódia.", "D) Trabalho forçado."], correct: 1, exp: "A execução visa punir mas fundamentalmente reintegrar o apenado." },
        { examId: 'ppmg_2026', type: 'leg_esp', q: "Individualização da pena (Lei 11.404) baseia-se em:", options: ["A) Sorteio.", "B) Exame criminológico e classificação.", "C) Apenas tipo de crime.", "D) Vontade do diretor."], correct: 1, exp: "A classificação através de exames orienta a individualização do tratamento." },
        { examId: 'ppmg_2026', type: 'leg_esp', q: "Fornecer bebida alcoólica a menor (ECA) é crime?", options: ["A) Não, é contravenção.", "B) Sim, crime do art. 243 do ECA.", "C) Apenas infração administrativa.", "D) Permitido com autorização dos pais."], correct: 1, exp: "É crime vender, fornecer, servir, ministrar ou entregar bebida alcoólica a criança ou adolescente." },

        // --- 20 QUESTÕES: LEI DE EXECUÇÃO PENAL (LEP - Focadas em AOCP/IBFC) ---
        { examId: 'ppmg_2026', type: 'lep', q: "Conforme a LEP, o condenado à pena privativa de liberdade está obrigado ao trabalho?", options: ["A) Não, é facultativo.", "B) Sim, na medida de suas aptidões e capacidade.", "C) Apenas para remir pena.", "D) Somente em regime fechado."], correct: 1, exp: "Art. 31: O condenado à pena privativa de liberdade está obrigado ao trabalho." },
        { examId: 'ppmg_2026', type: 'lep', q: "O trabalho do preso provisório:", options: ["A) É obrigatório.", "B) É proibido.", "C) Não é obrigatório e só pode ser executado no interior do estabelecimento.", "D) É obrigatório apenas em obras públicas."], correct: 2, exp: "Art. 31, parágrafo único: Não é obrigatório e restrito ao interior." },
        { examId: 'ppmg_2026', type: 'lep', q: "A assistência ao egresso consiste em:", options: ["A) Orientação e apoio para reintegrá-lo à vida em liberdade e auxílio econômico (2 meses).", "B) Apenas alojamento.", "C) Emprego garantido.", "D) Isenção de impostos."], correct: 0, exp: "Art. 25: Orientação, apoio e auxílio material/econômico por 2 meses." },
        { examId: 'ppmg_2026', type: 'lep', q: "Sobre a disciplina: As faltas disciplinares classificam-se em:", options: ["A) Leves e graves (LEP).", "B) Leves, médias e graves.", "C) Apenas graves.", "D) Administrativas e Judiciais."], correct: 1, exp: "Art. 49: Leves, médias e graves. A LEP só define as GRAVES; as demais são por legislação local." },
        { examId: 'ppmg_2026', type: 'lep', q: "É falta grave do condenado à pena privativa de liberdade:", options: ["A) Fumar na cela.", "B) Incitar ou participar de movimento para subverter a ordem ou a disciplina.", "C) Dormir tarde.", "D) Não tomar banho."], correct: 1, exp: "Art. 50, I: Subverter a ordem é falta grave típica." },
        { examId: 'ppmg_2026', type: 'lep', q: "O RDD (Regime Disciplinar Diferenciado) implica visitas:", options: ["A) Semanais.", "B) Quinzenais, de 2 pessoas por vez, sem contato físico.", "C) Mensais.", "D) Diárias."], correct: 1, exp: "Art. 52, III: Visitas quinzenais, 2 pessoas, sem contato físico." },
        { examId: 'ppmg_2026', type: 'lep', q: "A autoridade administrativa (diretor) pode decretar isolamento preventivo por até:", options: ["A) 30 dias.", "B) 10 dias.", "C) 20 dias.", "D) 5 dias."], correct: 1, exp: "Art. 60: Isolamento preventivo de até 10 dias. O RDD exige decisão judicial." },
        { examId: 'ppmg_2026', type: 'lep', q: "Órgão da execução penal composto por representantes da comunidade:", options: ["A) Conselho Penitenciário.", "B) Patronato.", "C) Conselho da Comunidade.", "D) Departamento Penitenciário."], correct: 2, exp: "Art. 80: O Conselho da Comunidade (associações, advogados, assistentes, etc)." },
        { examId: 'ppmg_2026', type: 'lep', q: "O estabelecimento penal destinado ao cumprimento de pena em regime semiaberto é:", options: ["A) Penitenciária.", "B) Cadeia Pública.", "C) Colônia Agrícola, Industrial ou Similar.", "D) Casa do Albergado."], correct: 2, exp: "Art. 91: A Colônia Agrícola destina-se ao regime semiaberto." },
        { examId: 'ppmg_2026', type: 'lep', q: "O estabelecimento destinado ao cumprimento de pena em regime aberto é:", options: ["A) Colônia.", "B) Casa do Albergado.", "C) Centro de Observação.", "D) Penitenciária."], correct: 1, exp: "Art. 93: A Casa do Albergado destina-se ao regime aberto." },
        { examId: 'ppmg_2026', type: 'lep', q: "A Cadeia Pública destina-se ao recolhimento de:", options: ["A) Presos condenados.", "B) Presos provisórios.", "C) Menores infratores.", "D) Doentes mentais."], correct: 1, exp: "Art. 102: A Cadeia Pública destina-se ao recolhimento de presos provisórios." },
        { examId: 'ppmg_2026', type: 'lep', q: "Para progressão de regime, o condenado deve cumprir o requisito objetivo (tempo) e subjetivo, que é:", options: ["A) Exame de DNA.", "B) Bom comportamento carcerário, comprovado pelo diretor.", "C) Pagamento de multa.", "D) Arrependimento."], correct: 1, exp: "Art. 112: Ostentar bom comportamento carcerário, atestado pelo diretor." },
        { examId: 'ppmg_2026', type: 'lep', q: "A 'Permissão de Saída' (art. 120) aplica-se em caso de:", options: ["A) Visita à família (feriados).", "B) Falecimento ou doença grave de cônjuge, companheira, ascendente, descendente ou irmão.", "C) Estudo externo.", "D) Trabalho externo."], correct: 1, exp: "A permissão de saída é humanitária (luto/doença) e concedida pelo diretor, com escolta." },
        { examId: 'ppmg_2026', type: 'lep', q: "A 'Saída Temporária' (art. 122) é destinada a presos em regime:", options: ["A) Fechado.", "B) Semiaberto.", "C) Aberto.", "D) Provisório."], correct: 1, exp: "Apenas condenados em regime semiaberto têm direito à saída temporária (sem escolta)." },
        { examId: 'ppmg_2026', type: 'lep', q: "Para concessão de Saída Temporária, exige-se cumprimento mínimo de pena de:", options: ["A) 1/6 (primário) ou 1/4 (reincidente).", "B) 1/3 para todos.", "C) Metade da pena.", "D) Não há tempo mínimo."], correct: 0, exp: "Art. 123, II: 1/6 se primário e 1/4 se reincidente." },
        { examId: 'ppmg_2026', type: 'lep', q: "O monitoramento eletrônico (tornozeleira) pode ser revogado se o acusado:", options: ["A) Arrumar emprego.", "B) Violar os deveres a que estiver sujeito ou cometer falta grave.", "C) Se comportar bem.", "D) Pagar a fiança."], correct: 1, exp: "Art. 146-D: A violação dos deveres acarreta a revogação." },
        { examId: 'ppmg_2026', type: 'lep', q: "A assistência material ao preso será prestada:", options: ["A) Pela família.", "B) Pelo Estado (alimentação, vestuário e instalações higiênicas).", "C) Pela Igreja.", "D) Por ONGs."], correct: 1, exp: "Art. 12: Dever do Estado fornecer o mínimo existencial material." },
        { examId: 'ppmg_2026', type: 'lep', q: "Mulheres presas têm direito a amamentar seus filhos no estabelecimento?", options: ["A) Não.", "B) Sim, até no mínimo 6 meses de idade.", "C) Sim, até 2 anos.", "D) Apenas se autorizadas pelo juiz."], correct: 1, exp: "Art. 83, § 2º: Os estabelecimentos terão berçário para amamentação até no mínimo 6 meses." },
        { examId: 'ppmg_2026', type: 'lep', q: "A remição por estudo conta como:", options: ["A) 1 dia de pena a cada 12 horas de frequência escolar (divididas em 3 dias).", "B) 1 dia por 1 dia de aula.", "C) 1 dia por mês.", "D) 2 dias por prova."], correct: 0, exp: "Art. 126, § 1º, I: 1 dia de pena a cada 12 horas de frequência escolar." },
        { examId: 'ppmg_2026', type: 'lep', q: "O rol de faltas graves previsto na LEP é:", options: ["A) Exemplificativo.", "B) Taxativo.", "C) Sugestivo.", "D) Opcional."], correct: 1, exp: "Entendimento pacífico: o rol de faltas graves (art. 50) é taxativo. Faltas médias e leves são locais." },

        // --- 20 QUESTÕES: DIREITO CONSTITUCIONAL (Focadas em PPMG/Art 5 e 144) ---
        { examId: 'ppmg_2026', type: 'const', q: "Segundo o Art. 144 da CF, a segurança pública é dever do Estado e:", options: ["A) Direito e responsabilidade de todos.", "B) Direito apenas dos cidadãos.", "C) Responsabilidade exclusiva da polícia.", "D) Facultativa para o Estado."], correct: 0, exp: "Caput do Art. 144: Dever do Estado, direito e responsabilidade de todos." },
        { examId: 'ppmg_2026', type: 'const', q: "As Polícias Penais (Federal, Estaduais e Distrital) foram criadas pela:", options: ["A) EC 45/2004.", "B) EC 104/2019.", "C) Constituição original de 88.", "D) Lei Ordinária."], correct: 1, exp: "A Emenda Constitucional 104/2019 criou as polícias penais no art. 144." },
        { examId: 'ppmg_2026', type: 'const', q: "Às Polícias Civis, dirigidas por delegados de carreira, incumbem:", options: ["A) O policiamento ostensivo.", "B) As funções de polícia judiciária e a apuração de infrações penais (exceto militares).", "C) A guarda dos presídios.", "D) O patrulhamento rodoviário."], correct: 1, exp: "Art. 144, § 4º: Polícia judiciária e apuração de infrações (exceto militares e competência da União)." },
        { examId: 'ppmg_2026', type: 'const', q: "Às Polícias Militares cabem:", options: ["A) A polícia ostensiva e a preservação da ordem pública.", "B) Investigar crimes.", "C) Emitir passaportes.", "D) Guardar presídios federais."], correct: 0, exp: "Art. 144, § 5º: Polícia ostensiva e preservação da ordem pública." },
        { examId: 'ppmg_2026', type: 'const', q: "A Polícia Federal exerce com exclusividade a função de:", options: ["A) Polícia ostensiva.", "B) Polícia judiciária da União.", "C) Polícia Militar.", "D) Guarda Municipal."], correct: 1, exp: "Art. 144, § 1º, IV: Exerce com exclusividade as funções de polícia judiciária da União." },
        { examId: 'ppmg_2026', type: 'const', q: "Os Municípios poderão constituir Guardas Municipais destinadas a:", options: ["A) Investigar homicídios.", "B) Proteger bens, serviços e instalações municipais.", "C) Policiamento ostensivo armado.", "D) Julgar multas."], correct: 1, exp: "Art. 144, § 8º: Proteção de seus bens, serviços e instalações." },
        { examId: 'ppmg_2026', type: 'const', q: "A casa é asilo inviolável. Nela se pode entrar sem consentimento À NOITE:", options: ["A) Com ordem judicial.", "B) Apenas em caso de flagrante delito, desastre ou para prestar socorro.", "C) Por suspeita.", "D) Nunca."], correct: 1, exp: "Art. 5º, XI: Ordem judicial só durante o dia. À noite, só flagrante, desastre ou socorro." },
        { examId: 'ppmg_2026', type: 'const', q: "Ninguém será submetido a tortura nem a tratamento:", options: ["A) Desumano ou degradante.", "B) Rigoroso.", "C) Disciplinar.", "D) Educativo."], correct: 0, exp: "Art. 5º, III: Tortura ou tratamento desumano ou degradante." },
        { examId: 'ppmg_2026', type: 'const', q: "É livre a manifestação do pensamento, sendo vedado:", options: ["A) A crítica.", "B) O anonimato.", "C) A internet.", "D) Falar de política."], correct: 1, exp: "Art. 5º, IV: Sendo vedado o anonimato." },
        { examId: 'ppmg_2026', type: 'const', q: "A prática do racismo constitui crime:", options: ["A) Afiançável.", "B) Inafiançável e imprescritível, sujeito à pena de reclusão.", "C) Prescritível.", "D) De menor potencial ofensivo."], correct: 1, exp: "Art. 5º, XLII: Racismo é inafiançável e imprescritível." },
        { examId: 'ppmg_2026', type: 'const', q: "São crimes inafiançáveis e insuscetíveis de graça ou anistia (3TH):", options: ["A) Roubo e Furto.", "B) Tortura, Tráfico, Terrorismo e os definidos como Hediondos.", "C) Calúnia e Difamação.", "D) Homicídio culposo."], correct: 1, exp: "Art. 5º, XLIII: 3TH (Tortura, Tráfico, Terrorismo, Hediondos)." },
        { examId: 'ppmg_2026', type: 'const', q: "Nenhum brasileiro será extraditado, salvo o:", options: ["A) Nato.", "B) Naturalizado, em caso de crime comum antes da naturalização ou tráfico a qualquer tempo.", "C) Político.", "D) Militar."], correct: 1, exp: "Art. 5º, LI: Nato nunca. Naturalizado sim (crime comum prévio ou tráfico)." },
        { examId: 'ppmg_2026', type: 'const', q: "Remédio constitucional para proteger direito líquido e certo (não amparado por HC/HD):", options: ["A) Habeas Corpus.", "B) Mandado de Segurança.", "C) Habeas Data.", "D) Ação Popular."], correct: 1, exp: "Art. 5º, LXIX: Mandado de Segurança." },
        { examId: 'ppmg_2026', type: 'const', q: "Remédio para garantir a liberdade de locomoção:", options: ["A) Mandado de Segurança.", "B) Habeas Corpus.", "C) Mandado de Injunção.", "D) Habeas Data."], correct: 1, exp: "Art. 5º, LXVIII: Habeas Corpus (locomoção)." },
        { examId: 'ppmg_2026', type: 'const', q: "As presidiárias serão asseguradas condições para que possam:", options: ["A) Trabalhar fora.", "B) Permanecer com seus filhos durante o período de amamentação.", "C) Ter celular.", "D) Sair quando quiserem."], correct: 1, exp: "Art. 5º, L: Permanecer com filhos na amamentação." },
        { examId: 'ppmg_2026', type: 'const', q: "Aos litigantes, em processo judicial ou administrativo, são assegurados:", options: ["A) O contraditório e a ampla defesa.", "B) O sigilo total.", "C) A condenação sumária.", "D) A ausência de advogado."], correct: 0, exp: "Art. 5º, LV: Contraditório e ampla defesa." },
        { examId: 'ppmg_2026', type: 'const', q: "A lei penal não retroagirá, salvo para:", options: ["A) Prejudicar o réu.", "B) Beneficiar o réu.", "C) Sempre retroage.", "D) Nunca retroage."], correct: 1, exp: "Art. 5º, XL: Salvo para beneficiar o réu." },
        { examId: 'ppmg_2026', type: 'const', q: "É reconhecida a instituição do júri para o julgamento de:", options: ["A) Crimes contra o patrimônio.", "B) Crimes dolosos contra a vida.", "C) Crimes de trânsito.", "D) Crimes militares."], correct: 1, exp: "Art. 5º, XXXVIII: Competência para crimes dolosos contra a vida." },
        { examId: 'ppmg_2026', type: 'const', q: "Ninguém será considerado culpado até:", options: ["A) A prisão.", "B) A denúncia.", "C) O trânsito em julgado de sentença penal condenatória.", "D) O interrogatório."], correct: 2, exp: "Art. 5º, LVII: Princípio da Presunção de Inocência (trânsito em julgado)." },
        { examId: 'ppmg_2026', type: 'const', q: "A identificação criminal civil não será exigida se houver identificação civil, salvo:", options: ["A) Nunca.", "B) Nas hipóteses previstas em lei.", "C) Sempre é exigida.", "D) Se o delegado quiser."], correct: 1, exp: "Art. 5º, LVIII: O civilmente identificado não será submetido a identificação criminal, salvo hipóteses legais." }
    ];

    // --- UI NAVIGATION ---
    window.navigate = (section) => {
        ['hub', 'exams', 'subjects', 'active-simulado', 'ranking'].forEach(s => {
            const el = document.getElementById(`section-${s}`);
            if (el) el.classList.add('hidden');
        });
        const target = document.getElementById(`section-${section}`);
        if (target) target.classList.remove('hidden');
        window.scrollTo(0,0);
        if (section === 'ranking') loadRankings();
    };

    window.selectInstitution = (instKey) => {
        currentInstitution = instKey;
        const inst = INSTITUTIONS_DATA[instKey];
        document.getElementById('current-institution-name').innerText = inst.name;
        
        const openList = document.getElementById('open-exams-list');
        const plannedList = document.getElementById('planned-exams-list');
        
        const openExams = inst.exams.filter(e => e.status === 'open');
        const plannedExams = inst.exams.filter(e => e.status === 'planned');

        const renderExam = (e) => `
            <div onclick="selectExam('${e.id}')" class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm cursor-pointer hover:border-blue-500 transition-all flex justify-between items-center group">
                <span class="font-bold text-slate-700 text-sm">${e.name}</span>
                <i class="fas fa-chevron-right text-slate-300 group-hover:text-blue-500 transition-colors"></i>
            </div>
        `;

        openList.innerHTML = openExams.length ? openExams.map(renderExam).join('') : '<p class="text-xs text-slate-400 italic">Nenhum edital aberto no momento.</p>';
        plannedList.innerHTML = plannedExams.length ? plannedExams.map(renderExam).join('') : '<p class="text-xs text-slate-400 italic">Nenhuma previsão confirmada.</p>';
        
        navigate('exams');
    };

    window.selectExam = (examId) => {
        currentExamId = examId;
        const inst = INSTITUTIONS_DATA[currentInstitution];
        const exam = inst.exams.find(e => e.id === examId);
        
        if (exam.status === 'planned') {
            showToast("Atenção: Este concurso está PREVISTO. Os simulados serão liberados assim que o edital oficial for publicado.", 'info');
            return;
        }

        document.getElementById('current-exam-name').innerText = exam.name;
        document.getElementById('current-exam-status').innerHTML = `
            <span class="text-slate-500">Matérias baseadas no edital.</span>
            <a href="${exam.pdfUrl}" target="_blank" class="inline-flex items-center gap-2 text-blue-600 hover:text-blue-800 text-xs font-bold mt-1 ml-2 transition-colors">
                <i class="fas fa-file-pdf"></i> Baixar Edital
            </a>
        `;
        
        const list = document.getElementById('subjects-list');
        list.innerHTML = exam.subjects.map(s => `
            <div onclick="startSimulado('${s.id}')" class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm cursor-pointer hover:border-blue-500 hover:shadow-md transition-all flex items-center gap-4 group">
                <div class="w-12 h-12 bg-slate-50 rounded-xl flex items-center justify-center text-slate-400 group-hover:text-blue-500 group-hover:bg-blue-50 transition-all"><i class="fas ${s.icon} text-xl"></i></div>
                <span class="font-bold text-slate-700">${s.name}</span>
            </div>
        `).join('');
        
        navigate('subjects');
    };

    // --- SIMULADO ---
    window.startSimulado = (subjectId) => {
        // Filtrar e selecionar 20 questões
        let filtered = DB_QUESTIONS.filter(q => q.examId === currentExamId && q.type === subjectId);
        
        // Se for legislação especial, embaralha e pega as 20
        // Se for outra materia, faz o mesmo (se houver questoes suficientes)
        activeQuestions = filtered.sort(() => Math.random() - 0.5).slice(0, 20);
        
        if (activeQuestions.length === 0) {
            showToast("Simulado em preparação para este edital específico!", 'info');
            return;
        }

        currentScore = 0; 
        answeredCount = 0;
        userAnswers = new Array(activeQuestions.length).fill(null); // Resetar vetor de respostas

        const inst = INSTITUTIONS_DATA[currentInstitution];
        const exam = inst.exams.find(e => e.id === currentExamId);
        const subObj = exam.subjects.find(s => s.id === subjectId);
        
        document.getElementById('simulado-title').innerText = subObj ? subObj.name : "Simulado";
        document.getElementById('simulado-counter').innerText = `0/${activeQuestions.length}`;
        
        renderQuestions();
        updateUI();
        navigate('active-simulado');
    };

    function renderQuestions() {
        const area = document.getElementById('questions-area');
        area.innerHTML = activeQuestions.map((q, i) => `
            <div id="q-card-${i}" class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 animate-fadeIn">
                <p class="text-xs font-bold text-blue-600 mb-2 uppercase tracking-wider">Questão ${i+1}</p>
                <p class="text-slate-800 font-bold mb-6 text-lg leading-relaxed">${q.q}</p>
                <div class="space-y-3">
                    ${q.options.map((opt, oi) => `
                        <label id="opt-label-${i}-${oi}" class="option-card block cursor-pointer">
                            <input type="radio" name="q${i}" class="hidden" onchange="answer(${i}, ${oi})">
                            <div class="p-4 rounded-2xl border-2 border-slate-100 transition-all flex items-center gap-4">
                                <span class="w-8 h-8 rounded-full border-2 border-slate-200 flex items-center justify-center text-xs font-bold text-slate-400">${String.fromCharCode(65+oi)}</span>
                                <span class="text-slate-700 font-medium">${opt}</span>
                            </div>
                        </label>
                    `).join('')}
                </div>
                <div id="feedback-${i}" class="hidden mt-6 p-5 rounded-2xl border"></div>
            </div>
        `).join('');
    }

    window.answer = (qi, oi) => {
        const q = activeQuestions[qi];
        const fb = document.getElementById(`feedback-${qi}`);
        const inputs = document.querySelectorAll(`input[name="q${qi}"]`);
        
        inputs.forEach(i => i.disabled = true);
        
        // --- FEEDBACK VISUAL ---
        const correctLabel = document.getElementById(`opt-label-${qi}-${q.correct}`);
        if(correctLabel) correctLabel.classList.add('correct');

        const isCorrect = oi === q.correct;
        
        if (!isCorrect) {
            const wrongLabel = document.getElementById(`opt-label-${qi}-${oi}`);
            if(wrongLabel) wrongLabel.classList.add('wrong');
        }

        // --- SALVAR DADOS PARA O PDF ---
        userAnswers[qi] = {
            question: q.q,
            options: q.options,
            selected: oi,
            correct: q.correct,
            explanation: q.exp,
            isCorrect: isCorrect
        };

        answeredCount++;
        if (isCorrect) currentScore++;
        
        fb.className = `mt-6 p-5 rounded-2xl border ${isCorrect ? 'bg-green-50 border-green-200 text-green-700' : 'bg-red-50 border-red-200 text-red-700'} block animate-fadeIn`;
        fb.innerHTML = `
            <p class="font-bold text-xs uppercase mb-2"><i class="fas ${isCorrect ? 'fa-check' : 'fa-times'} mr-2"></i>${isCorrect ? 'Resposta Correta' : 'Resposta Incorreta'}</p>
            <div class="text-slate-600 text-sm leading-relaxed p-3 bg-white/50 rounded-xl"><strong>Fundamentação:</strong> ${q.exp}</div>
        `;
        
        updateUI();
        if (answeredCount === activeQuestions.length) document.getElementById('finish-simulado-area').classList.remove('hidden');
    };

    function updateUI() {
        document.getElementById('progress-bar').style.width = `${(answeredCount/activeQuestions.length)*100}%`;
        document.getElementById('simulado-counter').innerText = `${answeredCount}/${activeQuestions.length}`;
    }

    // --- GERADOR DE PDF ---
    window.downloadResultPDF = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Cabeçalho
        doc.setFont("helvetica", "bold");
        doc.setFontSize(18);
        doc.text("Relatório de Desempenho - VF.DEV Hub", 20, 20);
        
        doc.setFontSize(12);
        doc.setFont("helvetica", "normal");
        doc.text(`Estudante: ${userName}`, 20, 30);
        doc.text(`Data: ${new Date().toLocaleDateString()}`, 20, 36);
        const score = Math.round((currentScore/activeQuestions.length)*100);
        doc.text(`Nota Final: ${score}% (${currentScore} de ${activeQuestions.length})`, 20, 42);

        let y = 55;
        const pageHeight = doc.internal.pageSize.height;

        userAnswers.forEach((ans, i) => {
            if (!ans) return;

            // Quebra de página
            if (y > pageHeight - 50) {
                doc.addPage();
                y = 20;
            }

            // Questão
            doc.setFont("helvetica", "bold");
            doc.setFontSize(11);
            doc.setTextColor(0, 0, 0);
            
            const questionText = `Q${i+1}) ${ans.question}`;
            const splitQuestion = doc.splitTextToSize(questionText, 170);
            doc.text(splitQuestion, 20, y);
            y += (splitQuestion.length * 5) + 3;

            // Resposta do Usuário
            doc.setFont("helvetica", "normal");
            doc.setFontSize(10);
            const selectedText = `Sua resposta: ${ans.options[ans.selected]}`;
            // Verde se acertou, Vermelho se errou
            doc.setTextColor(ans.isCorrect ? 0 : 200, ans.isCorrect ? 100 : 0, 0); 
            doc.text(selectedText, 25, y);
            y += 5;

            // Resposta Correta (apenas se errou)
            if (!ans.isCorrect) {
                doc.setTextColor(0, 100, 0); // Verde escuro
                doc.text(`Gabarito: ${ans.options[ans.correct]}`, 25, y);
                y += 5;
            }

            // Explicação
            doc.setTextColor(80, 80, 80); // Cinza
            doc.setFont("helvetica", "italic");
            const expText = `Motivo: ${ans.explanation}`;
            const splitExp = doc.splitTextToSize(expText, 160);
            doc.text(splitExp, 25, y);
            y += (splitExp.length * 4) + 10; // Espaço entre questões
        });

        doc.save(`simulado_vf_dev_${userName}_${new Date().getTime()}.pdf`);
    };

    window.saveSimuladoResult = async () => {
        const score = (currentScore/activeQuestions.length)*100;
        
        // Tentativa de reconexão se não houver usuário
        if (!auth.currentUser) {
            try {
                await signInAnonymously(auth);
            } catch (authError) {
                console.error("Falha na auto-reconexão:", authError);
                showToast("Erro de autenticação. Salvando apenas localmente (PDF).", 'error');
                downloadResultPDF(); 
                navigate('ranking');
                return;
            }
        }

        // Tenta pegar o UID ou usa um temporário se falhar muito
        const uid = auth.currentUser ? auth.currentUser.uid : 'anon-' + new Date().getTime();

        try {
            // Tenta salvar no Firebase
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'rankings'), { 
                userId: uid,
                name: userName || "Anônimo", 
                score, 
                date: new Date().toISOString(),
                exam: currentExamId,
                institution: currentInstitution
            });
            showToast(`Resultado salvo no Ranking!`, 'success');
            navigate('ranking');
        } catch (e) { 
            console.error("Erro ao salvar no Firestore:", e);
            // Fallback: Se falhar o banco, avisa que foi processado localmente
            showToast("Resultado processado (Modo Offline).", 'info');
            navigate('ranking');
        }
    };

    // --- RANKING LOGIC ---
    window.setRankingFilter = (filter) => {
        currentRankingFilter = filter;
        document.querySelectorAll('[id^="btn-rank-"]').forEach(btn => {
            const isSelected = btn.id === `btn-rank-${filter}`;
            btn.className = isSelected 
                ? "px-6 py-2 rounded-full text-sm font-bold bg-blue-600 text-white shadow-md transition-all"
                : "px-6 py-2 rounded-full text-sm font-bold bg-white text-slate-500 border border-slate-200 hover:border-blue-300 hover:text-blue-600 transition-all";
        });
        renderRankingList();
    };

    function renderRankingList() {
        const list = document.getElementById('ranking-list');
        let filteredData = allRankingsData;
        if (currentRankingFilter !== 'all') {
            filteredData = allRankingsData.filter(d => {
                if (currentRankingFilter === 'ppmg') return d.institution === 'ppmg' || (d.exam && d.exam.startsWith('ppmg'));
                if (currentRankingFilter === 'ufmg') return d.institution === 'ufmg' || (d.exam && d.exam.startsWith('ufmg'));
                return true;
            });
        }
        const topData = filteredData.slice(0, 10);
        if (topData.length === 0) { 
            list.innerHTML = `<p class="text-center text-slate-400 py-10">Ainda não há pontuações para esta categoria.</p>`; 
            return; 
        }
        list.innerHTML = topData.map((d, i) => `
            <div class="flex items-center justify-between p-4 rounded-2xl ${i < 3 ? 'bg-amber-50 border border-amber-100 shadow-sm' : 'bg-slate-50'} transition-all hover:scale-[1.01]">
                <div class="flex items-center gap-3">
                    <span class="w-6 text-sm font-bold ${i === 0 ? 'text-amber-500' : 'text-slate-400'}">#${i+1}</span>
                    <div class="flex flex-col">
                        <span class="font-bold text-slate-800">${d.name}</span>
                        <span class="text-[10px] text-slate-400 uppercase">${d.exam ? d.exam.replace('_', ' ').toUpperCase() : 'SIMULADO'}</span>
                    </div>
                </div>
                <span class="font-extrabold text-blue-800 text-lg">${Math.round(d.score)}%</span>
            </div>
        `).join('');
    }

    function loadRankings() {
        const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'rankings'), orderBy('score', 'desc'), limit(100));
        onSnapshot(q, (s) => {
            allRankingsData = [];
            s.forEach(doc => allRankingsData.push(doc.data()));
            renderRankingList();
        }, () => {
            document.getElementById('ranking-list').innerHTML = "Erro ao carregar ranking.";
        });
    }

    // --- INITIALIZE ---
    async function initializeSystem() {
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };
        await initAuth();

        onAuthStateChanged(auth, (u) => {
            user = u;
            if (u) {
                const savedNick = localStorage.getItem('user_nick');
                if (savedNick) {
                    userName = savedNick;
                    document.getElementById('display-name').innerText = userName;
                    document.getElementById('login-modal').classList.add('hidden');
                    navigate('hub');
                    loadRankings(); 
                } else {
                    document.getElementById('login-modal').classList.remove('hidden');
                }
            } else {
                document.getElementById('login-modal').classList.remove('hidden');
            }
        });
    }

    initializeSystem();
</script>
</body>
</html>
