<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VF.DEV | Hub de Concursos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google AdSense - Script Principal -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-XXXXXXXXXXXXXXXX" crossorigin="anonymous"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .penal-gradient { background: linear-gradient(135deg, #1e3a8a 0%, #1e1b4b 100%); }
        .ufmg-gradient { background: linear-gradient(135deg, #991b1b 0%, #450a0a 100%); }
        
        .option-card:hover input + div { border-color: #3b82f6; background-color: #eff6ff; }
        input:checked + div { border-color: #1e40af; background-color: #dbeafe; }

        .animate-fadeIn { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .ad-container {
            margin: 2rem auto; 
            text-align: center; 
            background: #f1f5f9; 
            border-radius: 1rem;
            padding: 1rem; 
            min-height: 100px; 
            width: 100%; 
            min-width: 250px;
            position: relative; 
            border: 1px dashed #cbd5e1;
            display: block;
            overflow: hidden;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

<!-- HEADER -->
<header class="penal-gradient text-white sticky top-0 z-50 shadow-xl">
    <div class="max-w-7xl mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
        <div class="flex items-center gap-3">
            <div class="bg-white/20 p-2 rounded-lg"><i class="fas fa-shield-halved text-2xl"></i></div>
            <div>
                <h1 class="text-xl font-bold tracking-tight text-white uppercase leading-none">VF<span class="text-red-500">.DEV</span></h1>
                <div id="user-badge" class="text-[10px] font-medium text-blue-200 flex items-center gap-1 mt-1">
                    <span class="w-2 h-2 bg-green-400 rounded-full"></span>
                    <span id="display-name">Visitante</span>
                </div>
            </div>
        </div>
        <nav class="flex gap-2">
            <button onclick="navigate('hub')" class="px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-sm font-semibold flex items-center gap-2 transition-all">
                <i class="fas fa-th-large"></i> Hub
            </button>
            <button onclick="navigate('ranking')" class="px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-sm font-semibold flex items-center gap-2 transition-all">
                <i class="fas fa-trophy"></i> Ranking
            </button>
            <button onclick="handleLogout()" class="px-4 py-2 rounded-lg bg-red-500/10 hover:bg-red-500/20 text-red-400 text-sm font-semibold transition-all">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </nav>
    </div>
</header>

<!-- AUTH MODAL -->
<div id="login-modal" class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/95 p-4 transition-opacity duration-500">
    <div class="bg-white rounded-2xl p-8 max-w-md w-full shadow-2xl text-center">
        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-6">
            <i class="fas fa-graduation-cap text-2xl text-blue-700"></i>
        </div>
        <h2 id="auth-title" class="text-2xl font-bold text-slate-800 mb-2">Plataforma VF.DEV</h2>
        <p class="text-slate-500 mb-6 text-sm text-balance">Estude para PPMG e concursos da UFMG (PRORH) em um só lugar.</p>
        
        <button onclick="handleGoogleLogin()" class="w-full flex items-center justify-center gap-3 bg-white border-2 border-slate-200 hover:bg-slate-50 text-slate-700 font-bold py-3 rounded-xl transition-all mb-4">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20" alt="Google">
            Entrar com Google
        </button>

        <div class="relative my-6">
            <div class="absolute inset-0 flex items-center"><span class="w-full border-t"></span></div>
            <div class="relative flex justify-center text-xs uppercase"><span class="bg-white px-2 text-slate-400">Ou e-mail</span></div>
        </div>

        <div class="space-y-3">
            <input type="email" id="email-input" placeholder="E-mail" class="w-full px-4 py-3 rounded-xl border-2 border-slate-200 focus:border-blue-500 focus:outline-none text-sm">
            <input type="password" id="password-input" placeholder="Palavra-passe" class="w-full px-4 py-3 rounded-xl border-2 border-slate-200 focus:border-blue-500 focus:outline-none text-sm">
            <input type="text" id="nickname-input" placeholder="Alcunha para o Ranking" class="hidden w-full px-4 py-3 rounded-xl border-2 border-slate-200 focus:border-blue-500 focus:outline-none text-sm">
        </div>

        <button id="auth-submit" onclick="handleAuthSubmit()" class="w-full bg-blue-700 hover:bg-blue-800 text-white font-bold py-3 rounded-xl transition-all shadow-lg mt-6">
            ENTRAR
        </button>

        <div class="mt-4 text-sm text-slate-500">
            <span id="auth-toggle-text">Ainda não tem conta?</span>
            <button onclick="toggleAuthMode()" class="text-blue-600 font-bold hover:underline ml-1" id="auth-toggle-btn">Criar Conta</button>
        </div>
    </div>
</div>

<main class="flex-grow max-w-5xl mx-auto w-full p-4 md:p-6">
    
    <!-- HUB SECTION -->
    <section id="section-hub" class="space-y-6 animate-fadeIn">
        <div class="text-center mb-8">
            <h2 class="text-3xl font-extrabold text-slate-800">Selecione seu Foco</h2>
            <p class="text-slate-500">Escolha a instituição para visualizar os editais disponíveis.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- PPMG -->
            <div onclick="selectInstitution('ppmg')" class="group cursor-pointer bg-white rounded-3xl p-8 shadow-sm border border-slate-200 transition-all hover:shadow-xl hover:-translate-y-2">
                <div class="w-16 h-16 penal-gradient rounded-2xl flex items-center justify-center text-white mb-6 group-hover:rotate-6 transition-transform">
                    <i class="fas fa-gavel text-2xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-slate-800">PPMG</h3>
                <p class="text-slate-500 text-sm mt-2">Polícia Penal de Minas Gerais. Conteúdo jurídico técnico e segurança pública.</p>
                <div class="mt-6 flex items-center text-blue-600 font-bold text-sm">
                    Ver Editais <i class="fas fa-arrow-right ml-2 group-hover:translate-x-2 transition-transform"></i>
                </div>
            </div>

            <!-- UFMG -->
            <div onclick="selectInstitution('ufmg')" class="group cursor-pointer bg-white rounded-3xl p-8 shadow-sm border border-slate-200 transition-all hover:shadow-xl hover:-translate-y-2">
                <div class="w-16 h-16 ufmg-gradient rounded-2xl flex items-center justify-center text-white mb-6 group-hover:rotate-6 transition-transform">
                    <i class="fas fa-university text-2xl"></i>
                </div>
                <div class="flex justify-between items-start">
                    <h3 class="text-2xl font-bold text-slate-800">UFMG</h3>
                    <span class="bg-red-100 text-red-700 text-[10px] font-bold px-2 py-1 rounded-full uppercase">PRORH</span>
                </div>
                <p class="text-slate-500 text-sm mt-2">Editais da Universidade Federal de Minas Gerais. Técnico-Administrativos e Docentes.</p>
                <div class="mt-6 flex items-center text-red-600 font-bold text-sm">
                    Ver Editais <i class="fas fa-arrow-right ml-2 group-hover:translate-x-2 transition-transform"></i>
                </div>
            </div>
        </div>
    </section>

    <!-- EXAMS SELECTION (NEW LAYER) -->
    <section id="section-exams" class="hidden animate-fadeIn space-y-6">
        <div class="flex items-center gap-4 mb-6">
            <button onclick="navigate('hub')" class="w-10 h-10 rounded-full bg-white shadow-sm border flex items-center justify-center text-slate-400 hover:text-slate-800 transition-colors"><i class="fas fa-arrow-left"></i></button>
            <h2 class="text-2xl font-bold text-slate-800" id="current-institution-name">Concursos</h2>
        </div>
        
        <div class="space-y-8">
            <div>
                <h3 class="text-lg font-bold text-green-600 mb-4 flex items-center gap-2"><i class="fas fa-unlock"></i> Concursos em Aberto</h3>
                <div id="open-exams-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>
            <div>
                <h3 class="text-lg font-bold text-amber-600 mb-4 flex items-center gap-2"><i class="fas fa-hourglass-half"></i> Concursos Previstos</h3>
                <div id="planned-exams-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>
        </div>
    </section>

    <!-- SUBJECTS SECTION -->
    <section id="section-subjects" class="hidden animate-fadeIn space-y-6">
        <div class="flex items-center gap-4 mb-6">
            <button onclick="navigate('exams')" class="w-10 h-10 rounded-full bg-white shadow-sm border flex items-center justify-center text-slate-400 hover:text-slate-800 transition-colors"><i class="fas fa-arrow-left"></i></button>
            <div class="flex flex-col">
                <h2 class="text-xl font-bold text-slate-800" id="current-exam-name">Disciplinas do Edital</h2>
                <div id="current-exam-status"></div>
            </div>
        </div>
        <div id="subjects-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
    </section>

    <!-- SIMULADO SCREEN -->
    <section id="section-active-simulado" class="hidden">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
            <div class="flex items-center gap-3">
                <button onclick="navigate('subjects')" class="w-10 h-10 rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200 transition-colors"><i class="fas fa-arrow-left"></i></button>
                <h2 class="text-xl font-bold text-slate-800" id="simulado-title">Simulado</h2>
            </div>
            <div class="flex items-center gap-4 w-full md:w-auto">
                <div class="flex-grow md:w-48 bg-slate-200 h-2 rounded-full overflow-hidden">
                    <div id="progress-bar" class="bg-blue-600 h-full w-0 transition-all duration-500"></div>
                </div>
                <div class="font-bold text-blue-700 whitespace-nowrap" id="simulado-counter">0/10</div>
            </div>
        </div>
        <div id="questions-area" class="space-y-6"></div>
        <div id="finish-simulado-area" class="hidden py-10 text-center">
            <button onclick="saveSimuladoResult()" class="bg-blue-700 hover:bg-blue-800 text-white font-bold py-4 px-10 rounded-2xl shadow-xl transition-all hover:scale-105">CONSOLIDAR RESULTADO</button>
        </div>
    </section>

    <!-- RANKING SECTION -->
    <section id="section-ranking" class="hidden animate-fadeIn space-y-6">
        <div class="text-center mb-10">
            <div class="inline-block p-3 bg-amber-100 text-amber-600 rounded-2xl mb-4"><i class="fas fa-trophy text-2xl"></i></div>
            <h2 class="text-3xl font-bold text-slate-800">Hall da Fama dos Estudantes</h2>
            <p class="text-slate-500">Métricas consolidadas de aproveitamento.</p>
        </div>

        <!-- Filtros do Ranking -->
        <div class="flex justify-center gap-2 mb-6">
            <button onclick="setRankingFilter('all')" id="btn-rank-all" class="px-6 py-2 rounded-full text-sm font-bold bg-blue-600 text-white shadow-md hover:bg-blue-700 transition-all">Geral</button>
            <button onclick="setRankingFilter('ppmg')" id="btn-rank-ppmg" class="px-6 py-2 rounded-full text-sm font-bold bg-white text-slate-500 border border-slate-200 hover:border-blue-300 hover:text-blue-600 transition-all">PPMG</button>
            <button onclick="setRankingFilter('ufmg')" id="btn-rank-ufmg" class="px-6 py-2 rounded-full text-sm font-bold bg-white text-slate-500 border border-slate-200 hover:border-blue-300 hover:text-blue-600 transition-all">UFMG</button>
        </div>

        <div class="max-w-2xl mx-auto bg-white rounded-3xl p-6 shadow-sm border border-slate-200">
            <div id="ranking-list" class="space-y-3 text-center text-slate-400 py-10">Conectando ao banco...</div>
        </div>
    </section>

</main>

<!-- ADSENSE -->
<div class="max-w-5xl mx-auto w-full px-4 md:px-6">
    <div class="ad-container" id="ad-hub-footer">
        <span class="ad-label">Anúncio</span>
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-XXXXXXXXXXXXXXXX"
             data-ad-slot="YYYYYYYYYY"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
    </div>
</div>

<footer class="bg-slate-100 py-8 mt-12 border-t border-slate-200 text-center text-slate-400 text-[10px] font-medium">
    VF.DEV © 2026 - Hub Independente de Engenharia Penal e Concursos Federais.
</footer>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, onSnapshot, query, orderBy, limit, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

    // --- FIREBASE CONFIG (ATUALIZADO) ---
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
        apiKey: "AIzaSyDzXxf_dalGOjJ_ADh3nSlkYuHYvMzvO0w",
        authDomain: "ambiente-de-estudo-43550.firebaseapp.com",
        projectId: "ambiente-de-estudo-43550",
        storageBucket: "ambiente-de-estudo-43550.firebasestorage.app",
        messagingSenderId: "220895066892",
        appId: "1:220895066892:web:8290428dc86f0a04836729",
        measurementId: "G-RH3X5HYT4B"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const analytics = getAnalytics(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'vf-dev-hub-v1';

    // --- GLOBAL STATE ---
    let user = null;
    let userName = "Estudante Visitante";
    let isRegistering = false;
    let currentInstitution = 'ppmg';
    let currentExamId = '';
    let activeQuestions = [];
    let currentScore = 0;
    let answeredCount = 0;
    let allRankingsData = [];
    let currentRankingFilter = 'all';
    const apiKey = ""; 

    // --- AUTH LOGIC ---
    window.handleGoogleLogin = async () => {
        const provider = new GoogleAuthProvider();
        try {
            const result = await signInWithPopup(auth, provider);
            // Salvar o nome do Google como alcunha se ainda não existir
            if (result.user) {
                const existingNick = localStorage.getItem(`nick_${result.user.uid}`);
                if (!existingNick) {
                    localStorage.setItem(`nick_${result.user.uid}`, result.user.displayName);
                }
            }
        } catch (e) { alert("Erro ao acessar com Google. Tente novamente."); console.error(e); }
    };

    window.handleAuthSubmit = async () => {
        const email = document.getElementById('email-input').value.trim();
        const password = document.getElementById('password-input').value;
        const nickname = document.getElementById('nickname-input').value.trim();
        if (!email || !password) return alert("Preencha os campos obrigatórios.");
        try {
            if (isRegistering) {
                if (!nickname) return alert("Defina uma alcunha.");
                const res = await createUserWithEmailAndPassword(auth, email, password);
                localStorage.setItem(`nick_${res.user.uid}`, nickname);
            } else {
                await signInWithEmailAndPassword(auth, email, password);
            }
        } catch (e) { alert("Falha na autenticação: Verifique os dados."); }
    };

    window.toggleAuthMode = () => {
        isRegistering = !isRegistering;
        const nick = document.getElementById('nickname-input');
        const title = document.getElementById('auth-title');
        const submit = document.getElementById('auth-submit');
        const toggleBtn = document.getElementById('auth-toggle-btn');
        const toggleText = document.getElementById('auth-toggle-text');

        if (isRegistering) {
            nick.classList.remove('hidden');
            title.innerText = "Criar Conta";
            submit.innerText = "REGISTAR";
            toggleBtn.innerText = "Entrar";
            toggleText.innerText = "Já tem conta?";
        } else {
            nick.classList.add('hidden');
            title.innerText = "Iniciar Sessão";
            submit.innerText = "ENTRAR";
            toggleBtn.innerText = "Criar Conta";
            toggleText.innerText = "Ainda não tem conta?";
        }
    };

    window.handleLogout = () => signOut(auth).then(() => window.location.reload());

    // --- DATA STRUCTURE (EDITAL-BASED) ---
    const INSTITUTIONS_DATA = {
        'ppmg': {
            name: 'PPMG (Polícia Penal MG)',
            exams: [
                {
                    id: 'ppmg_2026',
                    name: 'Polícia Penal - Edital 2025/2026',
                    status: 'open',
                    pdfUrl: 'https://www.institutoaocp.org.br/concursos/672', 
                    subjects: [
                        { id: 'lep', name: 'Lei de Execução Penal', icon: 'fa-gavel' },
                        { id: 'const', name: 'Direito Constitucional', icon: 'fa-balance-scale' }
                    ]
                }
            ]
        },
        'ufmg': {
            name: 'UFMG (Concursos PRORH / COPEVE)',
            exams: [
                {
                    id: 'ufmg_tae_2025',
                    name: 'Técnico-Administrativo (TAE) - Edital 01/2025',
                    status: 'open',
                    pdfUrl: 'https://arq.pciconcursos.com.br/ufmg-abre-edital-de-concurso-publico-para-cargo-de-tecnico-administrativo-em-educacao/1692458/7ab8cc9fd2/edital_de_abertura_n_3428_2025_1692458.pdf',
                    subjects: [
                        { id: 'ufmg_pt', name: 'Língua Portuguesa', icon: 'fa-language' },
                        { id: 'ufmg_leg', name: 'Legislação (Lei 8.112)', icon: 'fa-scroll' },
                        { id: 'ufmg_adm', name: 'Noções de Adm. Pública', icon: 'fa-sitemap' }
                    ]
                },
                {
                    id: 'ufmg_docente_2026',
                    name: 'Docente - Diversas Áreas (Magistério)',
                    status: 'planned',
                    pdfUrl: 'https://site.copeve.ufmg.br/', 
                    subjects: [
                        { id: 'ufmg_didat', name: 'Didática e Legislação', icon: 'fa-chalkboard-teacher' }
                    ]
                }
            ]
        }
    };

    const DB_QUESTIONS = [
        // --- PPMG: Lei de Execução Penal (LEP) ---
        { examId: 'ppmg_2026', type: 'lep', q: "A assistência ao preso é dever do Estado. Qual NÃO é uma assistência prevista no Art. 11?", options: ["A) Material", "B) Jurídica", "C) Financeira para lazer", "D) Religiosa"], correct: 2, exp: "Art. 11: A assistência será: material, à saúde, jurídica, educacional, social e religiosa. Financeira para lazer não existe." },
        { examId: 'ppmg_2026', type: 'lep', q: "A CTC (Comissão Técnica de Classificação) é presidida por:", options: ["A) Juiz da Execução", "B) Diretor do estabelecimento", "C) Delegado", "D) Promotor"], correct: 1, exp: "Art. 7º: A CTC será presidida pelo diretor do estabelecimento." },
        { examId: 'ppmg_2026', type: 'lep', q: "Ao condenado e ao internado serão assegurados todos os direitos não atingidos pela sentença ou lei. É proibida a distinção de natureza:", options: ["A) Racial, social, religiosa ou política", "B) Apenas racial", "C) Econômica apenas", "D) Nenhuma distinção é proibida"], correct: 0, exp: "Art. 3º, Parágrafo único." },
        { examId: 'ppmg_2026', type: 'lep', q: "O trabalho externo para presos em regime fechado é permitido?", options: ["A) Nunca", "B) Sim, em obras públicas com cautela", "C) Sim, em qualquer empresa", "D) Apenas com monitoramento"], correct: 1, exp: "Art. 36: Admissível apenas em serviço ou obras públicas." },
        { examId: 'ppmg_2026', type: 'lep', q: "Comete falta GRAVE o condenado que:", options: ["A) Reclama da comida", "B) Incita subversão da ordem", "C) Chega atrasado", "D) Não limpa a cela"], correct: 1, exp: "Art. 50, I: Incitar ou participar de movimento para subverter a ordem ou a disciplina." },
        { examId: 'ppmg_2026', type: 'lep', q: "Qual a duração máxima do RDD (Regime Disciplinar Diferenciado)?", options: ["A) 360 dias", "B) Até 2 anos", "C) 1 ano", "D) Indeterminado"], correct: 1, exp: "Art. 52, I: Duração máxima de até 2 anos." },
        { examId: 'ppmg_2026', type: 'lep', q: "A permissão de saída em caso de falecimento de parente é concedida por:", options: ["A) Juiz", "B) Diretor do estabelecimento", "C) MP", "D) Conselho"], correct: 1, exp: "Art. 120: Concedida pelo diretor do estabelecimento." },
        { examId: 'ppmg_2026', type: 'lep', q: "O trabalho do preso provisório é:", options: ["A) Obrigatório", "B) Facultativo", "C) Proibido", "D) Remunerado em dobro"], correct: 1, exp: "Art. 31, Parágrafo único: O trabalho do preso provisório não é obrigatório." },
        { examId: 'ppmg_2026', type: 'lep', q: "A remição de pena pelo trabalho ocorre na proporção de:", options: ["A) 1 dia de pena a cada 3 trabalhados", "B) 1 para 1", "C) 2 para 3", "D) 10 para 1"], correct: 0, exp: "Art. 126, § 1º, II: 1 dia de pena a cada 3 dias de trabalho." },
        { examId: 'ppmg_2026', type: 'lep', q: "Os órgãos da execução penal incluem, EXCETO:", options: ["A) Conselho Nacional de Política Criminal", "B) Juízo da Execução", "C) OAB", "D) Conselho Penitenciário"], correct: 2, exp: "A OAB não é órgão da execução penal (Art. 61)." },

        // --- PPMG: Direito Constitucional ---
        { examId: 'ppmg_2026', type: 'const', q: "Não haverá pena de morte, salvo em caso de:", options: ["A) Terrorismo", "B) Guerra declarada", "C) Homicídio qualificado", "D) Tráfico"], correct: 1, exp: "Art. 5º, XLVII, 'a'." },
        { examId: 'ppmg_2026', type: 'const', q: "A casa é asilo inviolável. Durante a noite, só se pode entrar:", options: ["A) Por ordem judicial", "B) Em flagrante, desastre ou socorro", "C) Por suspeita", "D) Com autorização do delegado"], correct: 1, exp: "Art. 5º, XI." },
        { examId: 'ppmg_2026', type: 'const', q: "As Polícias Penais são vinculadas a:", options: ["A) Judiciário", "B) Órgão adm. do sistema penal", "C) Polícia Civil", "D) Ministério da Justiça"], correct: 1, exp: "Art. 144, § 5º-A." },
        { examId: 'ppmg_2026', type: 'const', q: "Racismo é crime:", options: ["A) Afiançável", "B) Inafiançável e imprescritível", "C) Prescritível", "D) De menor potencial"], correct: 1, exp: "Art. 5º, XLII." },
        { examId: 'ppmg_2026', type: 'const', q: "Remédio para proteger direito líquido e certo:", options: ["A) Habeas Corpus", "B) Mandado de Segurança", "C) Habeas Data", "D) Ação Popular"], correct: 1, exp: "Art. 5º, LXIX." },
        { examId: 'ppmg_2026', type: 'const', q: "São princípios da Administração Pública (LIMPE), exceto:", options: ["A) Legalidade", "B) Celeridade", "C) Moralidade", "D) Eficiência"], correct: 1, exp: "Celeridade não está no caput do Art. 37 (é princípio processual)." },
        { examId: 'ppmg_2026', type: 'const', q: "Brasileiro nato pode ser extraditado?", options: ["A) Nunca", "B) Sim, por tráfico", "C) Sim, se perder a nacionalidade", "D) Sim, por terrorismo"], correct: 0, exp: "Art. 5º, LI: Nenhum brasileiro será extraditado, salvo o naturalizado." },
        { examId: 'ppmg_2026', type: 'const', q: "A tortura é crime:", options: ["A) Afiançável", "B) Inafiançável e insuscetível de graça", "C) Prescritível", "D) Anistiável"], correct: 1, exp: "Art. 5º, XLIII." },
        { examId: 'ppmg_2026', type: 'const', q: "A segurança pública é dever:", options: ["A) Do Estado apenas", "B) Do Estado, direito e responsabilidade de todos", "C) Das Forças Armadas", "D) Da Polícia Federal"], correct: 1, exp: "Art. 144, caput." },
        { examId: 'ppmg_2026', type: 'const', q: "É livre a manifestação do pensamento, sendo vedado:", options: ["A) A crítica", "B) O anonimato", "C) A arte", "D) O debate"], correct: 1, exp: "Art. 5º, IV." },

        // --- UFMG: Língua Portuguesa ---
        { examId: 'ufmg_tae_2025', type: 'ufmg_pt', q: "Em 'Ele chegou cedo', o termo 'cedo' é:", options: ["A) Adjetivo", "B) Advérbio", "C) Verbo", "D) Conjunção"], correct: 1, exp: "Indica circunstância de tempo (advérbio)." },
        { examId: 'ufmg_tae_2025', type: 'ufmg_pt', q: "Assinale a crase correta:", options: ["A) Fomos à praia", "B) Andar à pé", "C) Referiu-se à ele", "D) Cara à cara"], correct: 0, exp: "'Praia' é feminino e admite artigo 'a'. As outras opções estão erradas." },
        { examId: 'ufmg_tae_2025', type: 'ufmg_pt', q: "Qual palavra é paroxítona?", options: ["A) Café", "B) Mesa", "C) Cântico", "D) Anel"], correct: 1, exp: "A sílaba tônica é a penúltima (ME-sa)." },
        { examId: 'ufmg_tae_2025', type: 'ufmg_pt', q: "O verbo 'haver' no sentido de existir:", options: ["A) Tem plural", "B) É impessoal (sempre singular)", "C) Concorda com o sujeito", "D) Nenhuma das anteriores"], correct: 1, exp: "Haver (existir) é impessoal." },
        { examId: 'ufmg_tae_2025', type: 'ufmg_pt', q: "Antônimo de 'efêmero':", options: ["A) Breve", "B) Duradouro", "C) Rápido", "D) Passageiro"], correct: 1, exp: "Efêmero é passageiro; duradouro é o oposto." },
        { examId: 'ufmg_tae_2025', type: 'ufmg_pt', q: "'Mim' não conjuga verbo. A frase correta é:", options: ["A) Para mim fazer", "B) Para eu fazer", "C) Entre eu e você", "D) Mim gosta"], correct: 1, exp: "Sujeito de infinitivo deve ser o pronome reto 'eu'." },
        { examId: 'ufmg_tae_2025', type: 'ufmg_pt', q: "Figura de linguagem em 'Chorou rios de lágrimas':", options: ["A) Metáfora", "B) Hipérbole", "C) Antítese", "D) Pleonasmo"], correct: 1, exp: "Hipérbole é o exagero intencional." },
        { examId: 'ufmg_tae_2025', type: 'ufmg_pt', q: "Regência correta de 'assistir' (ver):", options: ["A) Assistir o filme", "B) Assistir ao filme", "C) Assistir no filme", "D) Assistir do filme"], correct: 1, exp: "Exige preposição 'a'." },
        { examId: 'ufmg_tae_2025', type: 'ufmg_pt', q: "Plural de 'cidadão':", options: ["A) Cidadões", "B) Cidadãos", "C) Cidadães", "D) Cidadãoes"], correct: 1, exp: "A forma correta é cidadãos." },
        { examId: 'ufmg_tae_2025', type: 'ufmg_pt', q: "Uso do porquê em final de frase:", options: ["A) Porque", "B) Por que", "C) Porquê", "D) Por quê"], correct: 3, exp: "Separado e com acento em final de frase." },

        // --- UFMG: Legislação (8.112) ---
        { examId: 'ufmg_tae_2025', type: 'ufmg_leg', q: "Segundo a 8.112, a demissão gera:", options: ["A) Provimento", "B) Vacância", "C) Readaptação", "D) Remoção"], correct: 1, exp: "Demissão desocupa o cargo (vacância)." },
        { examId: 'ufmg_tae_2025', type: 'ufmg_leg', q: "Validade do concurso público:", options: ["A) 1 ano", "B) Até 2 anos, prorrogável", "C) 4 anos fixos", "D) 5 anos"], correct: 1, exp: "Art. 12: Até 2 anos, prorrogável uma vez." },
        { examId: 'ufmg_tae_2025', type: 'ufmg_leg', q: "A investidura em cargo público ocorre com:", options: ["A) Nomeação", "B) Posse", "C) Exercício", "D) Aprovação"], correct: 1, exp: "Art. 7º: A investidura ocorrerá com a posse." },
        { examId: 'ufmg_tae_2025', type: 'ufmg_leg', q: "Estágio probatório tem duração de:", options: ["A) 24 meses", "B) 3 anos (36 meses)", "C) 12 meses", "D) 4 anos"], correct: 1, exp: "CF/88 alterou para 3 anos." },
        { examId: 'ufmg_tae_2025', type: 'ufmg_leg', q: "Reintegração é o retorno do servidor:", options: ["A) Aposentado", "B) Demitido invalidada a demissão", "C) Em disponibilidade", "D) Readaptado"], correct: 1, exp: "Art. 28: Retorno do demitido quando invalidada a demissão." },
        { examId: 'ufmg_tae_2025', type: 'ufmg_leg', q: "Prazo para posse após nomeação:", options: ["A) 15 dias", "B) 30 dias", "C) 60 dias", "D) 10 dias"], correct: 1, exp: "Art. 13, § 1º: 30 dias." },
        { examId: 'ufmg_tae_2025', type: 'ufmg_leg', q: "É proibido ao servidor:", options: ["A) Participar de gerência de empresa privada", "B) Tirar férias", "C) Se sindicalizar", "D) Fazer greve"], correct: 0, exp: "Art. 117, X: Proibido participar de gerência ou administração de sociedade privada." },
        { examId: 'ufmg_tae_2025', type: 'ufmg_leg', q: "Remoção a pedido, para acompanhar cônjuge:", options: ["A) Depende de vaga", "B) Independe de vaga", "C) É proibida", "D) Apenas no mesmo estado"], correct: 1, exp: "Art. 36, parágrafo único, III, 'a'." },
        { examId: 'ufmg_tae_2025', type: 'ufmg_leg', q: "Readaptação ocorre por:", options: ["A) Promoção", "B) Limitação física ou mental", "C) Idade", "D) Vontade política"], correct: 1, exp: "Art. 24." },
        { examId: 'ufmg_tae_2025', type: 'ufmg_leg', q: "Aposentadoria compulsória ocorre aos:", options: ["A) 70 anos", "B) 75 anos", "C) 65 anos", "D) 60 anos"], correct: 1, exp: "Atualmente 75 anos (LC 152/2015)." },

        // --- UFMG: Adm. Pública ---
        { examId: 'ufmg_tae_2025', type: 'ufmg_adm', q: "São princípios explícitos no Art. 37 (LIMPE), exceto:", options: ["A) Legalidade", "B) Impessoalidade", "C) Proporcionalidade", "D) Publicidade"], correct: 2, exp: "Proporcionalidade é princípio implícito." },
        { examId: 'ufmg_tae_2025', type: 'ufmg_adm', q: "Ato administrativo deve ter:", options: ["A) Competência, Finalidade, Forma, Motivo, Objeto", "B) Apenas Motivo", "C) Apenas Forma", "D) Vontade do agente"], correct: 0, exp: "Requisitos: CO-FI-FO-MO-OB." },
        { examId: 'ufmg_tae_2025', type: 'ufmg_adm', q: "A desconcentração administrativa cria:", options: ["A) Entes (Pessoas Jurídicas)", "B) Órgãos (dentro da mesma PJ)", "C) Empresas privadas", "D) ONGs"], correct: 1, exp: "Desconcentração = Órgãos (mesma pessoa)." },
        { examId: 'ufmg_tae_2025', type: 'ufmg_adm', q: "A descentralização administrativa cria:", options: ["A) Órgãos", "B) Entidades (Nova Pessoa Jurídica)", "C) Departamentos", "D) Seções"], correct: 1, exp: "Descentralização = Entidades (nova pessoa)." },
        { examId: 'ufmg_tae_2025', type: 'ufmg_adm', q: "Poder que permite aplicar sanções:", options: ["A) Hierárquico", "B) Disciplinar", "C) Normativo", "D) Vinculado"], correct: 1, exp: "Poder Disciplinar." },
        { examId: 'ufmg_tae_2025', type: 'ufmg_adm', q: "Abuso de poder pode ser:", options: ["A) Excesso de poder ou desvio de finalidade", "B) Apenas excesso", "C) Apenas desvio", "D) Uso correto"], correct: 0, exp: "Gênero abuso tem duas espécies: excesso e desvio." },
        { examId: 'ufmg_tae_2025', type: 'ufmg_adm', q: "Licitação é dispensável em:", options: ["A) Obras grandes", "B) Emergência ou calamidade", "C) Compra de material comum", "D) Contratação de qualquer serviço"], correct: 1, exp: "Art. 75 da Lei 14.133 (Nova Lei de Licitações)." },
        { examId: 'ufmg_tae_2025', type: 'ufmg_adm', q: "Responsabilidade civil do Estado é:", options: ["A) Subjetiva", "B) Objetiva", "C) Inexistente", "D) Penal"], correct: 1, exp: "Art. 37, § 6º da CF: Objetiva (independe de dolo/culpa)." },
        { examId: 'ufmg_tae_2025', type: 'ufmg_adm', q: "Bens públicos de uso comum:", options: ["A) Prédio da prefeitura", "B) Praças e ruas", "C) Veículos oficiais", "D) Terrenos baldios"], correct: 1, exp: "Uso comum do povo." },
        { examId: 'ufmg_tae_2025', type: 'ufmg_adm', q: "Improbidade administrativa gera:", options: ["A) Prisão perpétua", "B) Suspensão dos direitos políticos", "C) Apenas multa", "D) Apenas advertência"], correct: 1, exp: "Art. 37, § 4º da CF." }
    ];

    // --- UI NAVIGATION ---
    window.navigate = (section) => {
        ['hub', 'exams', 'subjects', 'active-simulado', 'ranking'].forEach(s => {
            const el = document.getElementById(`section-${s}`);
            if (el) el.classList.add('hidden');
        });
        const target = document.getElementById(`section-${section}`);
        if (target) target.classList.remove('hidden');
        window.scrollTo(0,0);
        if (section === 'ranking') loadRankings();
    };

    window.selectInstitution = (instKey) => {
        currentInstitution = instKey;
        const inst = INSTITUTIONS_DATA[instKey];
        document.getElementById('current-institution-name').innerText = inst.name;
        
        const openList = document.getElementById('open-exams-list');
        const plannedList = document.getElementById('planned-exams-list');
        
        const openExams = inst.exams.filter(e => e.status === 'open');
        const plannedExams = inst.exams.filter(e => e.status === 'planned');

        const renderExam = (e) => `
            <div onclick="selectExam('${e.id}')" class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm cursor-pointer hover:border-blue-500 transition-all flex justify-between items-center group">
                <span class="font-bold text-slate-700 text-sm">${e.name}</span>
                <i class="fas fa-chevron-right text-slate-300 group-hover:text-blue-500 transition-colors"></i>
            </div>
        `;

        openList.innerHTML = openExams.length ? openExams.map(renderExam).join('') : '<p class="text-xs text-slate-400 italic">Nenhum edital aberto no momento.</p>';
        plannedList.innerHTML = plannedExams.length ? plannedExams.map(renderExam).join('') : '<p class="text-xs text-slate-400 italic">Nenhuma previsão confirmada.</p>';
        
        navigate('exams');
    };

    window.selectExam = (examId) => {
        currentExamId = examId;
        const inst = INSTITUTIONS_DATA[currentInstitution];
        const exam = inst.exams.find(e => e.id === examId);
        
        if (exam.status === 'planned') {
            alert("Atenção: Este concurso está PREVISTO. Os simulados serão liberados assim que o edital oficial for publicado.");
            return;
        }

        document.getElementById('current-exam-name').innerText = exam.name;
        document.getElementById('current-exam-status').innerHTML = `
            <span class="text-slate-500">Matérias baseadas no edital.</span>
            <a href="${exam.pdfUrl}" target="_blank" class="inline-flex items-center gap-2 text-blue-600 hover:text-blue-800 text-xs font-bold mt-1 ml-2 transition-colors">
                <i class="fas fa-file-pdf"></i> Baixar Edital
            </a>
        `;
        
        const list = document.getElementById('subjects-list');
        list.innerHTML = exam.subjects.map(s => `
            <div onclick="startSimulado('${s.id}')" class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm cursor-pointer hover:border-blue-500 hover:shadow-md transition-all flex items-center gap-4 group">
                <div class="w-12 h-12 bg-slate-50 rounded-xl flex items-center justify-center text-slate-400 group-hover:text-blue-500 group-hover:bg-blue-50 transition-all"><i class="fas ${s.icon} text-xl"></i></div>
                <span class="font-bold text-slate-700">${s.name}</span>
            </div>
        `).join('');
        
        navigate('subjects');
    };

    // --- SIMULADO ---
    window.startSimulado = (subjectId) => {
        activeQuestions = DB_QUESTIONS.filter(q => q.examId === currentExamId && q.type === subjectId).sort(() => Math.random() - 0.5).slice(0, 10);
        
        if (activeQuestions.length === 0) {
            alert("Simulado em preparação para este edital específico!");
            return;
        }

        currentScore = 0; 
        answeredCount = 0;
        
        const inst = INSTITUTIONS_DATA[currentInstitution];
        const exam = inst.exams.find(e => e.id === currentExamId);
        const subObj = exam.subjects.find(s => s.id === subjectId);
        
        document.getElementById('simulado-title').innerText = subObj ? subObj.name : "Simulado";
        renderQuestions();
        updateUI();
        navigate('active-simulado');
    };

    function renderQuestions() {
        const area = document.getElementById('questions-area');
        area.innerHTML = activeQuestions.map((q, i) => `
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 animate-fadeIn">
                <p class="text-xs font-bold text-blue-600 mb-2 uppercase tracking-wider">Questão ${i+1}</p>
                <p class="text-slate-800 font-bold mb-6 text-lg leading-relaxed">${q.q}</p>
                <div class="space-y-3">
                    ${q.options.map((opt, oi) => `
                        <label class="option-card block cursor-pointer">
                            <input type="radio" name="q${i}" class="hidden" onchange="answer(${i}, ${oi})">
                            <div class="p-4 rounded-2xl border-2 border-slate-100 transition-all flex items-center gap-4">
                                <span class="w-8 h-8 rounded-full border-2 border-slate-200 flex items-center justify-center text-xs font-bold text-slate-400">${String.fromCharCode(65+oi)}</span>
                                <span class="text-slate-700 font-medium">${opt}</span>
                            </div>
                        </label>
                    `).join('')}
                </div>
                <div id="feedback-${i}" class="hidden mt-6 p-5 rounded-2xl border"></div>
            </div>
        `).join('');
    }

    window.answer = (qi, oi) => {
        const q = activeQuestions[qi];
        const fb = document.getElementById(`feedback-${qi}`);
        const inputs = document.querySelectorAll(`input[name="q${qi}"]`);
        inputs.forEach(i => i.disabled = true);
        answeredCount++;
        const isCorrect = oi === q.correct;
        if (isCorrect) currentScore++;
        fb.className = `mt-6 p-5 rounded-2xl border ${isCorrect ? 'bg-green-50 border-green-200 text-green-700' : 'bg-red-50 border-red-200 text-red-700'} block animate-fadeIn`;
        fb.innerHTML = `
            <p class="font-bold text-xs uppercase mb-2"><i class="fas ${isCorrect ? 'fa-check' : 'fa-times'} mr-2"></i>${isCorrect ? 'Resposta Correta' : 'Resposta Incorreta'}</p>
            <div class="text-slate-600 text-sm leading-relaxed p-3 bg-white/50 rounded-xl"><strong>Informativo:</strong> ${q.exp}</div>
        `;
        updateUI();
        if (answeredCount === activeQuestions.length) document.getElementById('finish-simulado-area').classList.remove('hidden');
    };

    function updateUI() {
        document.getElementById('progress-bar').style.width = `${(answeredCount/activeQuestions.length)*100}%`;
        document.getElementById('simulado-counter').innerText = `${answeredCount}/${activeQuestions.length}`;
    }

    window.saveSimuladoResult = async () => {
        const score = (currentScore/activeQuestions.length)*100;
        try {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'rankings'), { 
                name: userName, 
                score, 
                date: new Date().toISOString(),
                exam: currentExamId,
                institution: currentInstitution // Added institution field for easier filtering
            });
            alert(`Concluído! Aproveitamento: ${Math.round(score)}%`);
            navigate('ranking');
        } catch (e) { alert("Erro ao salvar resultado."); }
    };

    // --- RANKING LOGIC ---
    window.setRankingFilter = (filter) => {
        currentRankingFilter = filter;
        
        // Update Buttons UI
        document.querySelectorAll('[id^="btn-rank-"]').forEach(btn => {
            const isSelected = btn.id === `btn-rank-${filter}`;
            btn.className = isSelected 
                ? "px-6 py-2 rounded-full text-sm font-bold bg-blue-600 text-white shadow-md transition-all"
                : "px-6 py-2 rounded-full text-sm font-bold bg-white text-slate-500 border border-slate-200 hover:border-blue-300 hover:text-blue-600 transition-all";
        });

        renderRankingList();
    };

    function renderRankingList() {
        const list = document.getElementById('ranking-list');
        
        // Filter Data
        let filteredData = allRankingsData;
        if (currentRankingFilter !== 'all') {
            filteredData = allRankingsData.filter(d => {
                if (currentRankingFilter === 'ppmg') return d.institution === 'ppmg' || (d.exam && d.exam.startsWith('ppmg'));
                if (currentRankingFilter === 'ufmg') return d.institution === 'ufmg' || (d.exam && d.exam.startsWith('ufmg'));
                return true;
            });
        }

        // Limit to top 10 after filter
        const topData = filteredData.slice(0, 10);

        if (topData.length === 0) { 
            list.innerHTML = `<p class="text-center text-slate-400 py-10">Ainda não há pontuações para esta categoria.</p>`; 
            return; 
        }

        list.innerHTML = topData.map((d, i) => `
            <div class="flex items-center justify-between p-4 rounded-2xl ${i < 3 ? 'bg-amber-50 border border-amber-100 shadow-sm' : 'bg-slate-50'} transition-all hover:scale-[1.01]">
                <div class="flex items-center gap-3">
                    <span class="w-6 text-sm font-bold ${i === 0 ? 'text-amber-500' : 'text-slate-400'}">#${i+1}</span>
                    <div class="flex flex-col">
                        <span class="font-bold text-slate-800">${d.name}</span>
                        <span class="text-[10px] text-slate-400 uppercase">${d.exam ? d.exam.replace('_', ' ').toUpperCase() : 'SIMULADO'}</span>
                    </div>
                </div>
                <span class="font-extrabold text-blue-800 text-lg">${Math.round(d.score)}%</span>
            </div>
        `).join('');
    }

    function loadRankings() {
        // Fetch more initially to allow client-side filtering
        const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'rankings'), orderBy('score', 'desc'), limit(100));
        
        onSnapshot(q, (s) => {
            allRankingsData = [];
            s.forEach(doc => allRankingsData.push(doc.data()));
            renderRankingList(); // Initial render
        }, () => {
            document.getElementById('ranking-list').innerHTML = "Erro ao carregar ranking.";
        });
    }

    // --- INITIALIZE ---
    async function initializeSystem() {
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };
        await initAuth();

        onAuthStateChanged(auth, (u) => {
            user = u;
            if (u) {
                const savedNick = localStorage.getItem(`nick_${u.uid}`) || u.displayName || u.email?.split('@')[0] || "Visitante";
                userName = savedNick;
                document.getElementById('display-name').innerText = userName;
                document.getElementById('login-modal').classList.add('hidden');
                navigate('hub');
                loadRankings();
            } else {
                document.getElementById('login-modal').classList.remove('hidden');
            }
        });

        window.addEventListener('load', () => {
            setTimeout(() => {
                try {
                    const ads = document.querySelectorAll('.adsbygoogle');
                    ads.forEach(ad => {
                        if (ad.offsetWidth > 0) (window.adsbygoogle = window.adsbygoogle || []).push({});
                    });
                } catch (e) {}
            }, 1000);
        });
    }

    initializeSystem();
</script>
</body>
</html>
