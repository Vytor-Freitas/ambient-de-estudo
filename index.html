<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VF.DEV | Hub de Concursos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Biblioteca para gerar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-XXXXXXXXXXXXXXXX" crossorigin="anonymous"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .penal-gradient { background: linear-gradient(135deg, #1e3a8a 0%, #1e1b4b 100%); }
        .ufmg-gradient { background: linear-gradient(135deg, #991b1b 0%, #450a0a 100%); }
        
        /* Estilos para o feedback visual das questões */
        .option-card { transition: all 0.2s; }
        .option-card input:checked + div { border-color: #1e40af; background-color: #dbeafe; }
        
        /* Classes aplicadas via JS após responder */
        .option-card.correct div { background-color: #dcfce7 !important; border-color: #22c55e !important; color: #14532d; }
        .option-card.wrong div { background-color: #fee2e2 !important; border-color: #ef4444 !important; color: #7f1d1d; }
        
        .animate-fadeIn { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .ad-container {
            margin: 2rem auto; 
            text-align: center; 
            background: #f1f5f9; 
            border-radius: 1rem;
            padding: 1rem; 
            min-height: 100px; 
            width: 100%; 
            min-width: 250px;
            position: relative; 
            border: 1px dashed #cbd5e1;
            display: block;
            overflow: hidden;
        }

        /* Toast Notifications */
        #toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .toast {
            min-width: 300px;
            padding: 1rem;
            border-radius: 0.5rem;
            background: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-left: 4px solid;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .toast.show { transform: translateX(0); }
        .toast-success { border-left-color: #22c55e; }
        .toast-error { border-left-color: #ef4444; }
        .toast-info { border-left-color: #3b82f6; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

<!-- TOAST CONTAINER -->
<div id="toast-container"></div>

<!-- HEADER -->
<header class="penal-gradient text-white sticky top-0 z-50 shadow-xl">
    <div class="max-w-7xl mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
        <div class="flex items-center gap-3">
            <div class="bg-white/20 p-2 rounded-lg"><i class="fas fa-shield-halved text-2xl"></i></div>
            <div>
                <h1 class="text-xl font-bold tracking-tight text-white uppercase leading-none">VF<span class="text-red-500">.DEV</span></h1>
                <div id="user-badge" class="text-[10px] font-medium text-blue-200 flex items-center gap-1 mt-1">
                    <span class="w-2 h-2 bg-green-400 rounded-full"></span>
                    <span id="display-name">Visitante</span>
                </div>
            </div>
        </div>
        <nav class="flex gap-2">
            <button onclick="navigate('hub')" class="px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-sm font-semibold flex items-center gap-2 transition-all">
                <i class="fas fa-th-large"></i> Hub
            </button>
            <button onclick="navigate('ranking')" class="px-4 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-sm font-semibold flex items-center gap-2 transition-all">
                <i class="fas fa-trophy"></i> Ranking
            </button>
            <button onclick="handleLogout()" class="px-4 py-2 rounded-lg bg-red-500/10 hover:bg-red-500/20 text-red-400 text-sm font-semibold transition-all">
                <i class="fas fa-sign-out-alt"></i> Sair
            </button>
        </nav>
    </div>
</header>

<!-- AUTH MODAL (SIMPLIFICADO - APENAS NICK) -->
<div id="login-modal" class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/95 p-4 transition-opacity duration-500">
    <div class="bg-white rounded-2xl p-8 max-w-md w-full shadow-2xl text-center relative">
        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-6">
            <i class="fas fa-user-astronaut text-2xl text-blue-700"></i>
        </div>
        <h2 class="text-2xl font-bold text-slate-800 mb-2">Identificação</h2>
        <p class="text-slate-500 mb-6 text-sm">Digite seu Nickname (Apelido) para acessar os simulados e ter seu nome no ranking.</p>
        
        <div class="space-y-4">
            <input type="text" id="nickname-input" placeholder="Seu apelido..." class="w-full px-4 py-4 rounded-xl border-2 border-slate-200 focus:border-blue-500 focus:outline-none text-lg text-center font-bold text-slate-700" maxlength="20">
            
            <button onclick="handleNickLogin()" class="w-full bg-blue-700 hover:bg-blue-800 text-white font-bold py-4 rounded-xl transition-all shadow-lg hover:shadow-xl hover:scale-[1.02]">
                ENTRAR NO HUB
            </button>
        </div>
        
        <p class="mt-6 text-xs text-slate-400">Ao entrar, seus resultados serão salvos no Hall da Fama.</p>
    </div>
</div>

<main class="flex-grow max-w-5xl mx-auto w-full p-4 md:p-6">
    
    <!-- HUB SECTION -->
    <section id="section-hub" class="space-y-6 animate-fadeIn">
        <div class="text-center mb-8">
            <h2 class="text-3xl font-extrabold text-slate-800">Selecione seu Foco</h2>
            <p class="text-slate-500">Escolha a instituição para visualizar os editais disponíveis.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- PPMG -->
            <div onclick="selectInstitution('ppmg')" class="group cursor-pointer bg-white rounded-3xl p-8 shadow-sm border border-slate-200 transition-all hover:shadow-xl hover:-translate-y-2">
                <div class="w-16 h-16 penal-gradient rounded-2xl flex items-center justify-center text-white mb-6 group-hover:rotate-6 transition-transform">
                    <i class="fas fa-gavel text-2xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-slate-800">PPMG</h3>
                <p class="text-slate-500 text-sm mt-2">Polícia Penal de Minas Gerais. Conteúdo jurídico técnico e segurança pública.</p>
                <div class="mt-6 flex items-center text-blue-600 font-bold text-sm">
                    Ver Editais <i class="fas fa-arrow-right ml-2 group-hover:translate-x-2 transition-transform"></i>
                </div>
            </div>

            <!-- UFMG -->
            <div onclick="selectInstitution('ufmg')" class="group cursor-pointer bg-white rounded-3xl p-8 shadow-sm border border-slate-200 transition-all hover:shadow-xl hover:-translate-y-2">
                <div class="w-16 h-16 ufmg-gradient rounded-2xl flex items-center justify-center text-white mb-6 group-hover:rotate-6 transition-transform">
                    <i class="fas fa-university text-2xl"></i>
                </div>
                <div class="flex justify-between items-start">
                    <h3 class="text-2xl font-bold text-slate-800">UFMG</h3>
                    <span class="bg-red-100 text-red-700 text-[10px] font-bold px-2 py-1 rounded-full uppercase">PRORH</span>
                </div>
                <p class="text-slate-500 text-sm mt-2">Editais da Universidade Federal de Minas Gerais. Técnico-Administrativos e Docentes.</p>
                <div class="mt-6 flex items-center text-red-600 font-bold text-sm">
                    Ver Editais <i class="fas fa-arrow-right ml-2 group-hover:translate-x-2 transition-transform"></i>
                </div>
            </div>
        </div>
    </section>

    <!-- EXAMS SELECTION -->
    <section id="section-exams" class="hidden animate-fadeIn space-y-6">
        <div class="flex items-center gap-4 mb-6">
            <button onclick="navigate('hub')" class="w-10 h-10 rounded-full bg-white shadow-sm border flex items-center justify-center text-slate-400 hover:text-slate-800 transition-colors"><i class="fas fa-arrow-left"></i></button>
            <h2 class="text-2xl font-bold text-slate-800" id="current-institution-name">Concursos</h2>
        </div>
        
        <div class="space-y-8">
            <div>
                <h3 class="text-lg font-bold text-green-600 mb-4 flex items-center gap-2"><i class="fas fa-unlock"></i> Concursos em Aberto</h3>
                <div id="open-exams-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>
            <div>
                <h3 class="text-lg font-bold text-amber-600 mb-4 flex items-center gap-2"><i class="fas fa-hourglass-half"></i> Concursos Previstos</h3>
                <div id="planned-exams-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>
        </div>
    </section>

    <!-- SUBJECTS SECTION -->
    <section id="section-subjects" class="hidden animate-fadeIn space-y-6">
        <div class="flex items-center gap-4 mb-6">
            <button onclick="navigate('exams')" class="w-10 h-10 rounded-full bg-white shadow-sm border flex items-center justify-center text-slate-400 hover:text-slate-800 transition-colors"><i class="fas fa-arrow-left"></i></button>
            <div class="flex flex-col">
                <h2 class="text-xl font-bold text-slate-800" id="current-exam-name">Disciplinas do Edital</h2>
                <div id="current-exam-status"></div>
            </div>
        </div>
        <div id="subjects-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
    </section>

    <!-- SIMULADO SCREEN -->
    <section id="section-active-simulado" class="hidden">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 bg-white p-4 rounded-2xl shadow-sm border border-slate-200 sticky top-[80px] z-40">
            <div class="flex items-center gap-3">
                <button onclick="navigate('subjects')" class="w-10 h-10 rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200 transition-colors"><i class="fas fa-arrow-left"></i></button>
                <h2 class="text-xl font-bold text-slate-800" id="simulado-title">Simulado</h2>
            </div>
            <div class="flex items-center gap-4 w-full md:w-auto">
                <div class="flex-grow md:w-48 bg-slate-200 h-2 rounded-full overflow-hidden">
                    <div id="progress-bar" class="bg-blue-600 h-full w-0 transition-all duration-500"></div>
                </div>
                <div class="font-bold text-blue-700 whitespace-nowrap" id="simulado-counter">0/20</div>
            </div>
        </div>
        <div id="questions-area" class="space-y-6"></div>
        <div id="finish-simulado-area" class="hidden py-10 text-center space-y-4">
            <button onclick="saveSimuladoResult()" class="bg-blue-700 hover:bg-blue-800 text-white font-bold py-4 px-10 rounded-2xl shadow-xl transition-all hover:scale-105 w-full md:w-auto">CONSOLIDAR RESULTADO</button>
            
            <button onclick="downloadResultPDF()" class="bg-white border-2 border-slate-200 text-slate-600 hover:bg-slate-50 font-bold py-3 px-8 rounded-xl shadow-sm transition-all flex items-center justify-center gap-2 w-full md:w-auto mx-auto">
                <i class="fas fa-file-pdf text-red-500"></i> BAIXAR GABARITO (PDF)
            </button>
        </div>
    </section>

    <!-- RANKING SECTION -->
    <section id="section-ranking" class="hidden animate-fadeIn space-y-6">
        <div class="text-center mb-10">
            <div class="inline-block p-3 bg-amber-100 text-amber-600 rounded-2xl mb-4"><i class="fas fa-trophy text-2xl"></i></div>
            <h2 class="text-3xl font-bold text-slate-800">Hall da Fama dos Estudantes</h2>
            <p class="text-slate-500">Métricas consolidadas de aproveitamento.</p>
        </div>

        <!-- Filtros do Ranking -->
        <div class="flex justify-center gap-2 mb-6">
            <button onclick="setRankingFilter('all')" id="btn-rank-all" class="px-6 py-2 rounded-full text-sm font-bold bg-blue-600 text-white shadow-md hover:bg-blue-700 transition-all">Geral</button>
            <button onclick="setRankingFilter('ppmg')" id="btn-rank-ppmg" class="px-6 py-2 rounded-full text-sm font-bold bg-white text-slate-500 border border-slate-200 hover:border-blue-300 hover:text-blue-600 transition-all">PPMG</button>
            <button onclick="setRankingFilter('ufmg')" id="btn-rank-ufmg" class="px-6 py-2 rounded-full text-sm font-bold bg-white text-slate-500 border border-slate-200 hover:border-blue-300 hover:text-blue-600 transition-all">UFMG</button>
        </div>

        <div class="max-w-2xl mx-auto bg-white rounded-3xl p-6 shadow-sm border border-slate-200">
            <div id="ranking-list" class="space-y-3 text-center text-slate-400 py-10">Conectando ao banco...</div>
        </div>
    </section>

</main>

<!-- ADSENSE -->
<div class="max-w-5xl mx-auto w-full px-4 md:px-6">
    <div class="ad-container" id="ad-hub-footer">
        <span class="ad-label">Anúncio</span>
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-XXXXXXXXXXXXXXXX"
             data-ad-slot="YYYYYYYYYY"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
    </div>
</div>

<footer class="bg-slate-100 py-8 mt-12 border-t border-slate-200 text-center text-slate-400 text-[10px] font-medium">
    VF.DEV © 2026 - Hub Independente de Engenharia Penal e Concursos Federais.
</footer>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, onSnapshot, query, orderBy, limit, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
    
    // --- FIREBASE CONFIG ---
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
        apiKey: "AIzaSyDzXxf_dalGOjJ_ADh3nSlkYuHYvMzvO0w",
        authDomain: "ambiente-de-estudo-43550.firebaseapp.com",
        projectId: "ambiente-de-estudo-43550",
        storageBucket: "ambiente-de-estudo-43550.firebasestorage.app",
        messagingSenderId: "220895066892",
        appId: "1:220895066892:web:33370a72e40df87f836729",
        measurementId: "G-NPGKL5T9R0"
    };
    
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'vf-dev-hub-v1';

    // --- GLOBAL STATE ---
    let user = null;
    let userName = "";
    let currentInstitution = 'ppmg';
    let currentExamId = '';
    let activeQuestions = [];
    let currentScore = 0;
    let answeredCount = 0;
    let userAnswers = []; // Armazena as respostas para o PDF
    let allRankingsData = [];
    let currentRankingFilter = 'all';

    // --- TOAST UTILS ---
    window.showToast = (message, type = 'info') => {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        
        let iconClass = 'fa-info-circle';
        if(type === 'success') iconClass = 'fa-check-circle text-green-500';
        if(type === 'error') iconClass = 'fa-exclamation-circle text-red-500';
        if(type === 'info') iconClass = 'fa-info-circle text-blue-500';

        toast.innerHTML = `
            <div class="flex items-center gap-3">
                <i class="fas ${iconClass} text-lg"></i>
                <span class="text-slate-700 text-sm font-medium">${message}</span>
            </div>
        `;
        
        container.appendChild(toast);
        requestAnimationFrame(() => toast.classList.add('show'));
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    };

    // --- AUTH LOGIC (NICKNAME ONLY) ---
    window.handleNickLogin = async () => {
        const nickInput = document.getElementById('nickname-input');
        const nick = nickInput.value.trim();
        
        if (!nick) return showToast("Por favor, digite um apelido para entrar.", 'error');
        if (nick.length < 3) return showToast("O apelido deve ter pelo menos 3 caracteres.", 'error');

        try {
            await signInAnonymously(auth);
            localStorage.setItem('user_nick', nick);
            userName = nick;
            document.getElementById('display-name').innerText = userName;
            document.getElementById('login-modal').classList.add('hidden');
            showToast(`Bem-vindo, ${nick}!`, 'success');
        } catch(e) { 
            console.error(e);
            showToast("Erro ao conectar. Tente novamente.", 'error'); 
        }
    };

    window.handleLogout = () => signOut(auth).then(() => {
        localStorage.removeItem('user_nick');
        window.location.reload();
    });

    // --- DATA STRUCTURE (EDITAL-BASED) ---
    const INSTITUTIONS_DATA = {
        'ppmg': {
            name: 'PPMG (Polícia Penal MG)',
            exams: [
                {
                    id: 'ppmg_2026',
                    name: 'Polícia Penal - Edital 2025/2026',
                    status: 'open',
                    pdfUrl: 'https://www.institutoaocp.org.br/concursos/672', 
                    subjects: [
                        { id: 'lep', name: 'Lei de Execução Penal', icon: 'fa-gavel' },
                        { id: 'const', name: 'Direito Constitucional', icon: 'fa-balance-scale' },
                        { id: 'leg_esp', name: 'Legislação Especial', icon: 'fa-book-open' } // ADICIONADO
                    ]
                }
            ]
        },
        'ufmg': {
            name: 'UFMG (Concursos PRORH / COPEVE)',
            exams: [
                {
                    id: 'ufmg_tae_2025',
                    name: 'Técnico-Administrativo (TAE) - Edital 01/2025',
                    status: 'open',
                    pdfUrl: 'https://arq.pciconcursos.com.br/ufmg-abre-edital-de-concurso-publico-para-cargo-de-tecnico-administrativo-em-educacao/1692458/7ab8cc9fd2/edital_de_abertura_n_3428_2025_1692458.pdf',
                    subjects: [
                        { id: 'ufmg_pt', name: 'Língua Portuguesa', icon: 'fa-language' },
                        { id: 'ufmg_leg', name: 'Legislação (Lei 8.112)', icon: 'fa-scroll' },
                        { id: 'ufmg_adm', name: 'Noções de Adm. Pública', icon: 'fa-sitemap' }
                    ]
                },
                {
                    id: 'ufmg_docente_2026',
                    name: 'Docente - Diversas Áreas (Magistério)',
                    status: 'planned',
                    pdfUrl: 'https://site.copeve.ufmg.br/', 
                    subjects: [
                        { id: 'ufmg_didat', name: 'Didática e Legislação', icon: 'fa-chalkboard-teacher' }
                    ]
                }
            ]
        }
    };

    // --- BANCO DE QUESTÕES (ATUALIZADO COM 20 QUESTÕES NOVAS PARA LEP E CONST) ---
    const DB_QUESTIONS = [
        // --- LEGISLAÇÃO ESPECIAL (20 Questões do PDF/Anterior) ---
        { examId: 'ppmg_2026', type: 'leg_esp', q: "Segundo o STF (RE 635659), o porte de cannabis sativa para uso pessoal:", options: ["A) É crime.", "B) É infração penal simples.", "C) Foi descriminalizado (ilícito administrativo).", "D) Foi legalizado."], correct: 2, exp: "O STF decidiu que o porte para uso pessoal não é crime, mas subsiste como ilícito administrativo." },
        { examId: 'ppmg_2026', type: 'leg_esp', q: "Tráfico privilegiado (art. 33, §4°):", options: ["A) É hediondo.", "B) Não admite substituição de pena.", "C) Aplica-se a réus primários e de bons antecedentes.", "D) Exige habitualidade."], correct: 2, exp: "Requisitos: primariedade, bons antecedentes, não dedicação a crimes, não integrar organização." },
        // ... (Adicione mais questões de Leg. Especial aqui conforme o código anterior) ...

        // --- LEI DE EXECUÇÃO PENAL (LEP) - 20 QUESTÕES ---
        { examId: 'ppmg_2026', type: 'lep', q: "O Regime Disciplinar Diferenciado (RDD) tem duração máxima de:", options: ["A) 360 dias.", "B) 1 ano.", "C) Até 2 anos, repetível em caso de nova falta grave.", "D) 60 dias."], correct: 2, exp: "Art. 52, I: Duração máxima de até 2 anos, sem prejuízo de repetição da sanção por nova falta grave." },
        { examId: 'ppmg_2026', type: 'lep', q: "A remição de pena pelo trabalho ocorre na proporção de:", options: ["A) 1 dia de pena por 3 de trabalho.", "B) 1 por 1.", "C) 2 por 3.", "D) 1 por 2."], correct: 0, exp: "Art. 126: 1 dia de pena a cada 3 dias de trabalho." },
        { examId: 'ppmg_2026', type: 'lep', q: "A saída temporária é concedida pelo:", options: ["A) Diretor do estabelecimento.", "B) Juiz da execução, ouvidos MP e administração penitenciária.", "C) Secretário de Estado.", "D) Conselho Penitenciário."], correct: 1, exp: "Art. 123: Concedida pelo Juiz da Execução." },
        { examId: 'ppmg_2026', type: 'lep', q: "A Permissão de Saída (falecimento de parente) é autorizada pelo:", options: ["A) Juiz.", "B) Diretor do estabelecimento.", "C) MP.", "D) Defensor."], correct: 1, exp: "Art. 120: Concedida pelo diretor do estabelecimento." },
        { examId: 'ppmg_2026', type: 'lep', q: "Constitui falta grave do condenado à pena privativa de liberdade:", options: ["A) Fugir.", "B) Reclamar da comida.", "C) Não trabalhar (se doente).", "D) Falar alto."], correct: 0, exp: "Art. 50: Fugir é falta grave." },
        { examId: 'ppmg_2026', type: 'lep', q: "O trabalho do preso provisório é:", options: ["A) Obrigatório.", "B) Facultativo.", "C) Proibido.", "D) Remunerado em dobro."], correct: 1, exp: "Art. 31, P.U: O trabalho do preso provisório não é obrigatório." },
        { examId: 'ppmg_2026', type: 'lep', q: "A assistência material consiste no fornecimento de:", options: ["A) Dinheiro.", "B) Alimentação, vestuário e instalações higiênicas.", "C) Apenas roupa.", "D) Cigarros."], correct: 1, exp: "Art. 12: A assistência material consistirá no fornecimento de alimentação, vestuário e instalações higiênicas." },
        { examId: 'ppmg_2026', type: 'lep', q: "Órgão que fiscaliza a execução penal:", options: ["A) OAB.", "B) Conselho da Comunidade.", "C) Apenas o Juiz.", "D) Polícia Militar."], correct: 1, exp: "Art. 80: O Conselho da Comunidade é um dos órgãos de execução." },
        { examId: 'ppmg_2026', type: 'lep', q: "O isolamento preventivo (sanção disciplinar) não excederá:", options: ["A) 30 dias.", "B) 10 dias.", "C) 60 dias.", "D) 15 dias."], correct: 1, exp: "Art. 60: A autoridade administrativa poderá decretar o isolamento preventivo por até 10 dias." },
        { examId: 'ppmg_2026', type: 'lep', q: "A progressão para o regime semiaberto exige cumprimento de percentual e:", options: ["A) Bom comportamento carcerário.", "B) Pagamento de fiança.", "C) Consentimento da vítima.", "D) Ser réu primário."], correct: 0, exp: "Art. 112: Requisito subjetivo é o bom comportamento carcerário." },
        { examId: 'ppmg_2026', type: 'lep', q: "O exame criminológico para progressão de regime:", options: ["A) É obrigatório sempre.", "B) É vedado.", "C) Pode ser determinado pelo juiz de forma fundamentada.", "D) Só para crimes leves."], correct: 2, exp: "Súmula Vinculante 26 e jurisprudência: não é obrigatório, mas o juiz pode exigir fundamentadamente." },
        { examId: 'ppmg_2026', type: 'lep', q: "Presas gestantes têm direito a acompanhamento médico:", options: ["A) Apenas no parto.", "B) Pré-natal e pós-parto, extensivo ao recém-nascido.", "C) Se pagarem.", "D) Não têm direito."], correct: 1, exp: "Art. 14, § 3º: Será assegurado acompanhamento médico à mulher, principalmente no pré-natal e no pós-parto." },
        { examId: 'ppmg_2026', type: 'lep', q: "O trabalho externo é admissível para presos em regime fechado?", options: ["A) Nunca.", "B) Sim, em serviços ou obras públicas.", "C) Sim, em empresas privadas.", "D) Apenas no último ano."], correct: 1, exp: "Art. 36: Admissível no regime fechado apenas em serviço ou obras públicas." },
        { examId: 'ppmg_2026', type: 'lep', q: "A comissão técnica de classificação (CTC) é presidida por:", options: ["A) Juiz.", "B) Psiquiatra.", "C) Diretor do estabelecimento.", "D) Assistente Social."], correct: 2, exp: "Art. 7º: Presidida pelo diretor." },
        { examId: 'ppmg_2026', type: 'lep', q: "Quem tem direito à assistência religiosa?", options: ["A) Só católicos.", "B) Todos os presos, com liberdade de culto.", "C) Ninguém.", "D) Só quem paga dízimo."], correct: 1, exp: "Art. 24: Assistência religiosa, com liberdade de culto, é garantida a todos." },
        { examId: 'ppmg_2026', type: 'lep', q: "O preso condenado à pena privativa de liberdade está obrigado ao trabalho?", options: ["A) Não, é facultativo.", "B) Sim, na medida de suas aptidões.", "C) Apenas se quiser remir pena.", "D) Depende do crime."], correct: 1, exp: "Art. 31: O condenado à pena privativa de liberdade está obrigado ao trabalho." },
        { examId: 'ppmg_2026', type: 'lep', q: "Limite de desconto na remuneração do preso (pecúlio/indenização):", options: ["A) Não pode descontar nada.", "B) Pode descontar tudo.", "C) Produto da remuneração deve atender indenização, assistência à família, despesas pessoais, etc.", "D) 10% fixo."], correct: 2, exp: "Art. 29: O produto da remuneração atenderá indenização, assistência à família, pequenas despesas e ressarcimento ao Estado." },
        { examId: 'ppmg_2026', type: 'lep', q: "Incumbe ao Conselho Penitenciário:", options: ["A) Julgar crimes.", "B) Emitir parecer sobre indulto e comutação de pena.", "C) Prender fugitivos.", "D) Criar leis."], correct: 1, exp: "Art. 70: Emitir parecer sobre indulto e comutação de pena." },
        { examId: 'ppmg_2026', type: 'lep', q: "A penitenciária de mulheres será dotada de seção para gestante e parturiente e de:", options: ["A) Escola de corte e costura.", "B) Creche para abrigar filhos maiores de 7 anos.", "C) Berçário para filhos até 6 meses (mínimo).", "D) Cozinha industrial."], correct: 2, exp: "Art. 89: Berçário para amamentação até no mínimo 6 meses." },
        { examId: 'ppmg_2026', type: 'lep', q: "Regime aberto baseia-se na:", options: ["A) Autodisciplina e senso de responsabilidade.", "B) Vigilância armada.", "C) Muralhas altas.", "D) Uso de algemas."], correct: 0, exp: "Art. 36: O regime aberto baseia-se na autodisciplina e senso de responsabilidade do condenado." },

        // --- DIREITO CONSTITUCIONAL (20 QUESTÕES) ---
        { examId: 'ppmg_2026', type: 'const', q: "Art. 144: A segurança pública é dever do Estado e responsabilidade de:", options: ["A) Apenas da polícia.", "B) Todos.", "C) Do Governo Federal.", "D) Das Forças Armadas."], correct: 1, exp: "Art. 144: Dever do Estado, direito e responsabilidade de todos." },
        { examId: 'ppmg_2026', type: 'const', q: "As Polícias Penais (Federal, Estaduais e Distrital) vinculam-se ao:", options: ["A) Poder Judiciário.", "B) Ministério Público.", "C) Órgão administrador do sistema penal da unidade federativa.", "D) Polícia Federal."], correct: 2, exp: "Art. 144, § 5º-A: Vinculadas ao órgão administrador do sistema penal." },
        { examId: 'ppmg_2026', type: 'const', q: "Cabe à Polícia Federal exercer com exclusividade a função de:", options: ["A) Polícia ostensiva.", "B) Polícia judiciária da União.", "C) Guarda de presídios estaduais.", "D) Patrulhamento rodoviário."], correct: 1, exp: "Art. 144, § 1º, IV: Exerce com exclusividade as funções de polícia judiciária da União." },
        { examId: 'ppmg_2026', type: 'const', q: "A casa é asilo inviolável. Pode-se entrar sem consentimento à noite apenas:", options: ["A) Com ordem judicial.", "B) Em caso de flagrante delito, desastre ou para prestar socorro.", "C) Por suspeita de crime.", "D) A qualquer momento."], correct: 1, exp: "Art. 5º, XI: À noite, só em flagrante, desastre ou socorro. Ordem judicial é só de dia." },
        { examId: 'ppmg_2026', type: 'const', q: "É crime inafiançável e imprescritível:", options: ["A) Homicídio.", "B) Racismo.", "C) Tortura.", "D) Tráfico."], correct: 1, exp: "Art. 5º, XLII: A prática do racismo constitui crime inafiançável e imprescritível." },
        { examId: 'ppmg_2026', type: 'const', q: "É crime inafiançável e insuscetível de graça ou anistia:", options: ["A) Racismo.", "B) Ação de grupos armados.", "C) Tortura, Tráfico, Terrorismo e Hediondos (3TH).", "D) Calúnia."], correct: 2, exp: "Art. 5º, XLIII: 3TH são inafiançáveis e insuscetíveis de graça ou anistia." },
        { examId: 'ppmg_2026', type: 'const', q: "Nenhum brasileiro será extraditado, salvo:", options: ["A) O nato.", "B) O naturalizado, em caso de crime comum antes da naturalização ou tráfico a qualquer tempo.", "C) Qualquer um.", "D) Ninguém."], correct: 1, exp: "Art. 5º, LI: O nato nunca. O naturalizado nas hipóteses de crime comum prévio ou tráfico." },
        { examId: 'ppmg_2026', type: 'const', q: "Remédio constitucional para garantir direito líquido e certo não amparado por HC ou HD:", options: ["A) Ação Popular.", "B) Mandado de Segurança.", "C) Mandado de Injunção.", "D) Habeas Corpus."], correct: 1, exp: "Art. 5º, LXIX: Mandado de Segurança." },
        { examId: 'ppmg_2026', type: 'const', q: "Remédio para assegurar o conhecimento de informações relativas à pessoa do impetrante (banco de dados):", options: ["A) Habeas Corpus.", "B) Habeas Data.", "C) Mandado de Segurança.", "D) Ação Civil Pública."], correct: 1, exp: "Art. 5º, LXXII: Habeas Data." },
        { examId: 'ppmg_2026', type: 'const', q: "Cargo privativo de brasileiro nato:", options: ["A) Deputado Federal (qualquer).", "B) Oficial das Forças Armadas.", "C) Policial Federal.", "D) Juiz de Direito."], correct: 1, exp: "Art. 12, § 3º: Oficial das Forças Armadas é privativo de nato." },
        { examId: 'ppmg_2026', type: 'const', q: "Princípios da Administração Pública (Art. 37 - LIMPE):", options: ["A) Legalidade, Impessoalidade, Moralidade, Publicidade e Eficiência.", "B) Legalidade, Interesse, Moderação.", "C) Licitude, Imparcialidade, Mérito.", "D) Lealdade, Igualdade, Modernidade."], correct: 0, exp: "Mnemônico LIMPE: Legalidade, Impessoalidade, Moralidade, Publicidade e Eficiência." },
        { examId: 'ppmg_2026', type: 'const', q: "É vedada a acumulação remunerada de cargos públicos, exceto (se houver compatibilidade de horários):", options: ["A) Dois de advogado.", "B) Dois de professor.", "C) Três de médico.", "D) Um de policial e um de juiz."], correct: 1, exp: "Art. 37, XVI: É permitida a acumulação de dois cargos de professor." },
        { examId: 'ppmg_2026', type: 'const', q: "A responsabilidade civil das pessoas jurídicas de direito público por danos que seus agentes causarem é:", options: ["A) Subjetiva (depende de culpa).", "B) Objetiva (independe de dolo ou culpa).", "C) Inexistente.", "D) Penal."], correct: 1, exp: "Art. 37, § 6º: Responsabilidade Objetiva (Teoria do Risco Administrativo)." },
        { examId: 'ppmg_2026', type: 'const', q: "O prazo de validade do concurso público é de:", options: ["A) Até 1 ano.", "B) Até 2 anos, prorrogável uma vez, por igual período.", "C) 4 anos fixos.", "D) Indeterminado."], correct: 1, exp: "Art. 37, III: Até dois anos, prorrogável uma vez." },
        { examId: 'ppmg_2026', type: 'const', q: "Não haverá penas de (Art. 5, XLVII):", options: ["A) Morte (salvo guerra declarada), caráter perpétuo, trabalhos forçados, banimento e cruéis.", "B) Prisão perpétua em qualquer caso.", "C) Multa.", "D) Restritiva de direitos."], correct: 0, exp: "Vedações expressas: morte (regra), perpétua, trabalhos forçados, banimento, cruéis." },
        { examId: 'ppmg_2026', type: 'const', q: "A polícia rodoviária federal destina-se ao:", options: ["A) Policiamento ostensivo das ferrovias.", "B) Patrulhamento ostensivo das rodovias federais.", "C) Investigação de crimes estaduais.", "D) Guarda de fronteira."], correct: 1, exp: "Art. 144, § 2º: Patrulhamento ostensivo das rodovias federais." },
        { examId: 'ppmg_2026', type: 'const', q: "Às polícias civis, dirigidas por delegados de carreira, incumbem:", options: ["A) Policiamento ostensivo.", "B) Funções de polícia judiciária e apuração de infrações penais (exceto militares).", "C) Julgar crimes.", "D) Defesa civil."], correct: 1, exp: "Art. 144, § 4º: Polícia judiciária estadual." },
        { examId: 'ppmg_2026', type: 'const', q: "Os Municípios poderão constituir:", options: ["A) Polícias Militares.", "B) Guardas Municipais (proteção de bens, serviços e instalações).", "C) Exército Municipal.", "D) Polícia Civil Municipal."], correct: 1, exp: "Art. 144, § 8º: Guardas Municipais." },
        { examId: 'ppmg_2026', type: 'const', q: "Direito de reunião (Art. 5, XVI):", options: ["A) Exige autorização do Estado.", "B) É livre, pacífico, sem armas, em locais abertos, independente de autorização (apenas prévio aviso).", "C) É proibido.", "D) Só em locais fechados."], correct: 1, exp: "Independe de autorização, sendo exigido apenas prévio aviso à autoridade competente." },
        { examId: 'ppmg_2026', type: 'const', q: "Ninguém será privado da liberdade ou de seus bens sem o:", options: ["A) Devido processo legal.", "B) Consentimento do vizinho.", "C) Pagamento de taxa.", "D) Aviso prévio de 30 dias."], correct: 0, exp: "Art. 5º, LIV: Devido processo legal (Due Process of Law)." }
    ];

    // --- UI NAVIGATION ---
    window.navigate = (section) => {
        ['hub', 'exams', 'subjects', 'active-simulado', 'ranking'].forEach(s => {
            const el = document.getElementById(`section-${s}`);
            if (el) el.classList.add('hidden');
        });
        const target = document.getElementById(`section-${section}`);
        if (target) target.classList.remove('hidden');
        window.scrollTo(0,0);
        if (section === 'ranking') loadRankings();
    };

    window.selectInstitution = (instKey) => {
        currentInstitution = instKey;
        const inst = INSTITUTIONS_DATA[instKey];
        document.getElementById('current-institution-name').innerText = inst.name;
        
        const openList = document.getElementById('open-exams-list');
        const plannedList = document.getElementById('planned-exams-list');
        
        const openExams = inst.exams.filter(e => e.status === 'open');
        const plannedExams = inst.exams.filter(e => e.status === 'planned');

        const renderExam = (e) => `
            <div onclick="selectExam('${e.id}')" class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm cursor-pointer hover:border-blue-500 transition-all flex justify-between items-center group">
                <span class="font-bold text-slate-700 text-sm">${e.name}</span>
                <i class="fas fa-chevron-right text-slate-300 group-hover:text-blue-500 transition-colors"></i>
            </div>
        `;

        openList.innerHTML = openExams.length ? openExams.map(renderExam).join('') : '<p class="text-xs text-slate-400 italic">Nenhum edital aberto no momento.</p>';
        plannedList.innerHTML = plannedExams.length ? plannedExams.map(renderExam).join('') : '<p class="text-xs text-slate-400 italic">Nenhuma previsão confirmada.</p>';
        
        navigate('exams');
    };

    window.selectExam = (examId) => {
        currentExamId = examId;
        const inst = INSTITUTIONS_DATA[currentInstitution];
        const exam = inst.exams.find(e => e.id === examId);
        
        if (exam.status === 'planned') {
            showToast("Atenção: Este concurso está PREVISTO. Os simulados serão liberados assim que o edital oficial for publicado.", 'info');
            return;
        }

        document.getElementById('current-exam-name').innerText = exam.name;
        document.getElementById('current-exam-status').innerHTML = `
            <span class="text-slate-500">Matérias baseadas no edital.</span>
            <a href="${exam.pdfUrl}" target="_blank" class="inline-flex items-center gap-2 text-blue-600 hover:text-blue-800 text-xs font-bold mt-1 ml-2 transition-colors">
                <i class="fas fa-file-pdf"></i> Baixar Edital
            </a>
        `;
        
        const list = document.getElementById('subjects-list');
        list.innerHTML = exam.subjects.map(s => `
            <div onclick="startSimulado('${s.id}')" class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm cursor-pointer hover:border-blue-500 hover:shadow-md transition-all flex items-center gap-4 group">
                <div class="w-12 h-12 bg-slate-50 rounded-xl flex items-center justify-center text-slate-400 group-hover:text-blue-500 group-hover:bg-blue-50 transition-all"><i class="fas ${s.icon} text-xl"></i></div>
                <span class="font-bold text-slate-700">${s.name}</span>
            </div>
        `).join('');
        
        navigate('subjects');
    };

    // --- SIMULADO ---
    window.startSimulado = (subjectId) => {
        // Filtrar e selecionar 20 questões
        let filtered = DB_QUESTIONS.filter(q => q.examId === currentExamId && q.type === subjectId);
        
        // Se for legislação especial, embaralha e pega as 20
        // Se for outra materia, faz o mesmo (se houver questoes suficientes)
        activeQuestions = filtered.sort(() => Math.random() - 0.5).slice(0, 20);
        
        if (activeQuestions.length === 0) {
            showToast("Simulado em preparação para este edital específico!", 'info');
            return;
        }

        currentScore = 0; 
        answeredCount = 0;
        userAnswers = new Array(activeQuestions.length).fill(null); // Resetar vetor de respostas

        const inst = INSTITUTIONS_DATA[currentInstitution];
        const exam = inst.exams.find(e => e.id === currentExamId);
        const subObj = exam.subjects.find(s => s.id === subjectId);
        
        document.getElementById('simulado-title').innerText = subObj ? subObj.name : "Simulado";
        document.getElementById('simulado-counter').innerText = `0/${activeQuestions.length}`;
        
        renderQuestions();
        updateUI();
        navigate('active-simulado');
    };

    function renderQuestions() {
        const area = document.getElementById('questions-area');
        area.innerHTML = activeQuestions.map((q, i) => `
            <div id="q-card-${i}" class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200 animate-fadeIn">
                <p class="text-xs font-bold text-blue-600 mb-2 uppercase tracking-wider">Questão ${i+1}</p>
                <p class="text-slate-800 font-bold mb-6 text-lg leading-relaxed">${q.q}</p>
                <div class="space-y-3">
                    ${q.options.map((opt, oi) => `
                        <label id="opt-label-${i}-${oi}" class="option-card block cursor-pointer">
                            <input type="radio" name="q${i}" class="hidden" onchange="answer(${i}, ${oi})">
                            <div class="p-4 rounded-2xl border-2 border-slate-100 transition-all flex items-center gap-4">
                                <span class="w-8 h-8 rounded-full border-2 border-slate-200 flex items-center justify-center text-xs font-bold text-slate-400">${String.fromCharCode(65+oi)}</span>
                                <span class="text-slate-700 font-medium">${opt}</span>
                            </div>
                        </label>
                    `).join('')}
                </div>
                <div id="feedback-${i}" class="hidden mt-6 p-5 rounded-2xl border"></div>
            </div>
        `).join('');
    }

    window.answer = (qi, oi) => {
        const q = activeQuestions[qi];
        const fb = document.getElementById(`feedback-${qi}`);
        const inputs = document.querySelectorAll(`input[name="q${qi}"]`);
        
        inputs.forEach(i => i.disabled = true);
        
        // --- FEEDBACK VISUAL ---
        const correctLabel = document.getElementById(`opt-label-${qi}-${q.correct}`);
        if(correctLabel) correctLabel.classList.add('correct');

        const isCorrect = oi === q.correct;
        
        if (!isCorrect) {
            const wrongLabel = document.getElementById(`opt-label-${qi}-${oi}`);
            if(wrongLabel) wrongLabel.classList.add('wrong');
        }

        // --- SALVAR DADOS PARA O PDF ---
        userAnswers[qi] = {
            question: q.q,
            options: q.options,
            selected: oi,
            correct: q.correct,
            explanation: q.exp,
            isCorrect: isCorrect
        };

        answeredCount++;
        if (isCorrect) currentScore++;
        
        fb.className = `mt-6 p-5 rounded-2xl border ${isCorrect ? 'bg-green-50 border-green-200 text-green-700' : 'bg-red-50 border-red-200 text-red-700'} block animate-fadeIn`;
        fb.innerHTML = `
            <p class="font-bold text-xs uppercase mb-2"><i class="fas ${isCorrect ? 'fa-check' : 'fa-times'} mr-2"></i>${isCorrect ? 'Resposta Correta' : 'Resposta Incorreta'}</p>
            <div class="text-slate-600 text-sm leading-relaxed p-3 bg-white/50 rounded-xl"><strong>Fundamentação:</strong> ${q.exp}</div>
        `;
        
        updateUI();
        if (answeredCount === activeQuestions.length) document.getElementById('finish-simulado-area').classList.remove('hidden');
    };

    function updateUI() {
        document.getElementById('progress-bar').style.width = `${(answeredCount/activeQuestions.length)*100}%`;
        document.getElementById('simulado-counter').innerText = `${answeredCount}/${activeQuestions.length}`;
    }

    // --- GERADOR DE PDF ---
    window.downloadResultPDF = () => {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Cabeçalho
        doc.setFont("helvetica", "bold");
        doc.setFontSize(18);
        doc.text("Relatório de Desempenho - VF.DEV Hub", 20, 20);
        
        doc.setFontSize(12);
        doc.setFont("helvetica", "normal");
        doc.text(`Estudante: ${userName}`, 20, 30);
        doc.text(`Data: ${new Date().toLocaleDateString()}`, 20, 36);
        const score = Math.round((currentScore/activeQuestions.length)*100);
        doc.text(`Nota Final: ${score}% (${currentScore} de ${activeQuestions.length})`, 20, 42);

        let y = 55;
        const pageHeight = doc.internal.pageSize.height;

        userAnswers.forEach((ans, i) => {
            if (!ans) return;

            // Quebra de página
            if (y > pageHeight - 50) {
                doc.addPage();
                y = 20;
            }

            // Questão
            doc.setFont("helvetica", "bold");
            doc.setFontSize(11);
            doc.setTextColor(0, 0, 0);
            
            const questionText = `Q${i+1}) ${ans.question}`;
            const splitQuestion = doc.splitTextToSize(questionText, 170);
            doc.text(splitQuestion, 20, y);
            y += (splitQuestion.length * 5) + 3;

            // Resposta do Usuário
            doc.setFont("helvetica", "normal");
            doc.setFontSize(10);
            const selectedText = `Sua resposta: ${ans.options[ans.selected]}`;
            // Verde se acertou, Vermelho se errou
            doc.setTextColor(ans.isCorrect ? 0 : 200, ans.isCorrect ? 100 : 0, 0); 
            doc.text(selectedText, 25, y);
            y += 5;

            // Resposta Correta (apenas se errou)
            if (!ans.isCorrect) {
                doc.setTextColor(0, 100, 0); // Verde escuro
                doc.text(`Gabarito: ${ans.options[ans.correct]}`, 25, y);
                y += 5;
            }

            // Explicação
            doc.setTextColor(80, 80, 80); // Cinza
            doc.setFont("helvetica", "italic");
            const expText = `Motivo: ${ans.explanation}`;
            const splitExp = doc.splitTextToSize(expText, 160);
            doc.text(splitExp, 25, y);
            y += (splitExp.length * 4) + 10; // Espaço entre questões
        });

        doc.save(`simulado_vf_dev_${userName}_${new Date().getTime()}.pdf`);
    };

    window.saveSimuladoResult = async () => {
        const score = (currentScore/activeQuestions.length)*100;
        
        // Tentativa de reconexão se não houver usuário
        if (!auth.currentUser) {
            try {
                await signInAnonymously(auth);
            } catch (authError) {
                console.error("Falha na auto-reconexão:", authError);
                showToast("Erro de autenticação. Salvando apenas localmente (PDF).", 'error');
                downloadResultPDF(); 
                navigate('ranking');
                return;
            }
        }

        // Tenta pegar o UID ou usa um temporário se falhar muito
        const uid = auth.currentUser ? auth.currentUser.uid : 'anon-' + new Date().getTime();

        try {
            // Tenta salvar no Firebase
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'rankings'), { 
                userId: uid,
                name: userName || "Anônimo", 
                score, 
                date: new Date().toISOString(),
                exam: currentExamId,
                institution: currentInstitution
            });
            showToast(`Resultado salvo no Ranking!`, 'success');
            navigate('ranking');
        } catch (e) { 
            console.error("Erro ao salvar no Firestore:", e);
            // Fallback: Se falhar o banco, avisa que foi processado localmente
            showToast("Resultado processado (Modo Offline).", 'info');
            navigate('ranking');
        }
    };

    // --- RANKING LOGIC ---
    window.setRankingFilter = (filter) => {
        currentRankingFilter = filter;
        document.querySelectorAll('[id^="btn-rank-"]').forEach(btn => {
            const isSelected = btn.id === `btn-rank-${filter}`;
            btn.className = isSelected 
                ? "px-6 py-2 rounded-full text-sm font-bold bg-blue-600 text-white shadow-md transition-all"
                : "px-6 py-2 rounded-full text-sm font-bold bg-white text-slate-500 border border-slate-200 hover:border-blue-300 hover:text-blue-600 transition-all";
        });
        renderRankingList();
    };

    function renderRankingList() {
        const list = document.getElementById('ranking-list');
        let filteredData = allRankingsData;
        if (currentRankingFilter !== 'all') {
            filteredData = allRankingsData.filter(d => {
                if (currentRankingFilter === 'ppmg') return d.institution === 'ppmg' || (d.exam && d.exam.startsWith('ppmg'));
                if (currentRankingFilter === 'ufmg') return d.institution === 'ufmg' || (d.exam && d.exam.startsWith('ufmg'));
                return true;
            });
        }
        const topData = filteredData.slice(0, 10);
        if (topData.length === 0) { 
            list.innerHTML = `<p class="text-center text-slate-400 py-10">Ainda não há pontuações para esta categoria.</p>`; 
            return; 
        }
        list.innerHTML = topData.map((d, i) => `
            <div class="flex items-center justify-between p-4 rounded-2xl ${i < 3 ? 'bg-amber-50 border border-amber-100 shadow-sm' : 'bg-slate-50'} transition-all hover:scale-[1.01]">
                <div class="flex items-center gap-3">
                    <span class="w-6 text-sm font-bold ${i === 0 ? 'text-amber-500' : 'text-slate-400'}">#${i+1}</span>
                    <div class="flex flex-col">
                        <span class="font-bold text-slate-800">${d.name}</span>
                        <span class="text-[10px] text-slate-400 uppercase">${d.exam ? d.exam.replace('_', ' ').toUpperCase() : 'SIMULADO'}</span>
                    </div>
                </div>
                <span class="font-extrabold text-blue-800 text-lg">${Math.round(d.score)}%</span>
            </div>
        `).join('');
    }

    function loadRankings() {
        const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'rankings'), orderBy('score', 'desc'), limit(100));
        onSnapshot(q, (s) => {
            allRankingsData = [];
            s.forEach(doc => allRankingsData.push(doc.data()));
            renderRankingList();
        }, () => {
            document.getElementById('ranking-list').innerHTML = "Erro ao carregar ranking.";
        });
    }

    // --- INITIALIZE ---
    async function initializeSystem() {
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };
        await initAuth();

        onAuthStateChanged(auth, (u) => {
            user = u;
            if (u) {
                const savedNick = localStorage.getItem('user_nick');
                if (savedNick) {
                    userName = savedNick;
                    document.getElementById('display-name').innerText = userName;
                    document.getElementById('login-modal').classList.add('hidden');
                    navigate('hub');
                    loadRankings(); 
                } else {
                    document.getElementById('login-modal').classList.remove('hidden');
                }
            } else {
                document.getElementById('login-modal').classList.remove('hidden');
            }
        });
    }

    initializeSystem();
</script>
</body>
</html>

